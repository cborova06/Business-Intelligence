import{s as ce,j as d,v as Q,aE as de,x as H,M as ae,r as S,o as p,c as N,w as U,f as u,h as m,K as g,u as le,B as ie,d as V,g as X,t as M,e as D,J as ve,F as z,y as pe,aC as fe,i as ge,L as _e,ad as se,ae as oe,U as he,a2 as xe,m as be,aJ as ye}from"./frappe-ui-d69b39da.js";import{f as re,b as ue,h as Te,ad as Ve,i as me,ae as ke,u as we,s as ne}from"./main-d2d228fc.js";import{_ as Ce}from"./UserSelector.vue_vue_type_script_setup_true_lang-09c49be5.js";import{u as Se}from"./users-398754d3.js";import{u as $e}from"./data_source-00c6028c.js";import{u as Ue}from"./tables-0e8be38f.js";import{a as De}from"./ExpressionEditor.vue_vue_type_style_index_0_lang-9e2463ac.js";import{C as Me}from"./chevron-down-7c5e9308.js";import{C as Ne}from"./chevron-right-abc82e4c.js";import{S as Be}from"./search-34ad51bc.js";import{_ as W}from"./SettingItem.vue_vue_type_script_setup_true_lang-59f6e724.js";import{P as Le}from"./plus-3394075c.js";import"./index-77f7bd6f.js";import"./text-cursor-input-3636b908.js";import"./combine-0dbf7ac7.js";import"./Autocomplete-e91e4d1c.js";import"./Popover-5414f173.js";import"./index-9194c21d.js";import"./toasts-2937f9d2.js";import"./calendar-1687c485.js";import"./clock-73e01da8.js";import"./vue-codemirror.esm-d1d2df5a.js";const q=d([]),Y=d(!1);async function K(y=""){return Y.value=!0,Q("insights.api.user.get_teams",{search_term:y}).then(c=>(q.value=c.map(v=>({...v,creation_from_now:de(v.creation),team_permissions:v.team_permissions.map(l=>({...l,type:Ee(l.resource_type)}))})),Y.value=!1,q.value))}const Z=d(!1);async function Ae(y){return Z.value=!0,Q("insights.api.user.create_team",{team_name:y}).then(()=>{K(),re({message:"Team created",variant:"success"})}).catch(c=>{ue(c)}).finally(()=>{Z.value=!1})}const ee=d(!1);async function Oe(y){return ee.value=!0,Q("insights.api.user.update_team",{team:y}).then(()=>{K(),re({message:"Team updated",variant:"success"})}).catch(c=>{ue(c)}).finally(()=>{ee.value=!1})}function te(){return q.value.length||K(),ce({teams:q,loading:Y,getTeams:K,creatingTeam:Z,createTeam:Ae,updatingTeam:ee,updateTeam:Oe})}function Ee(y){if(y==="Insights Data Source v3")return"Source";if(y==="Insights Table v3")return"Table"}const Fe={class:"flex flex-col gap-4"},Ie=H({__name:"CreateTeamDialog",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(y){const c=ae(y,"modelValue"),v=te(),l=d("");return(x,o)=>{const h=S("FormControl"),n=S("Dialog");return p(),N(n,{modelValue:c.value,"onUpdate:modelValue":o[1]||(o[1]=T=>c.value=T),options:{title:"Create Team",actions:[{label:"Create",variant:"solid",disabled:!l.value||g(v).creatingTeam,loading:g(v).creatingTeam,onClick:()=>{g(v).createTeam(l.value).then(()=>{l.value="",c.value=!1})}}]}},{"body-content":U(()=>[u("div",Fe,[m(h,{label:"Team Name",modelValue:l.value,"onUpdate:modelValue":o[0]||(o[0]=T=>l.value=T),autocomplete:"off"},null,8,["modelValue"])])]),_:1},8,["modelValue","options"])}}}),Pe=["data-source"],Je={class:"sticky top-0 z-10 flex items-center gap-2 bg-white py-1.5"},Re=["onClick"],je={class:"flex flex-shrink-0 select-none items-baseline gap-2"},ze={class:"group-hover:underline"},qe={key:0,class:"text-p-xs text-gray-700"},Ke={key:0,class:"flex flex-col gap-2.5 pl-6 pb-1.5"},Qe={class:"flex flex-col gap-1"},He={class:"group flex items-center gap-2"},Ge=["onClick"],We={class:"leading-5"},Xe=["onClick"],Ye={key:0,class:"ml-6 flex flex-col gap-1.5"},Ze={key:0,class:"flex items-center gap-2"},ea={class:"text-xs text-gray-600"},aa={key:1,class:"text-xs text-gray-600"},la=H({__name:"TeamResourceSelector",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(y){const c=ae(y,"modelValue"),v=$e(),l=Ue(),x=d([]),o=d({}),h=d({}),n=d(null),T=d({}),k=d({}),i=le(()=>n.value?T.value[n.value]||[]:[]);if(c.value.length){x.value=c.value.filter(a=>a.type==="Source").map(a=>a.resource_name);const e=c.value.filter(a=>a.type==="Table").map(a=>a.resource_name);e.length&&Q("insights.api.data_sources.get_data_sources_of_tables",{table_names:e}).then(a=>{o.value=a;for(const s of e){const b=c.value.find(t=>t.resource_name===s),B=b==null?void 0:b.table_restrictions;B&&(h.value[s]=B)}})}ie(()=>[x.value,o.value,h.value],()=>{const e=x.value.map(t=>({type:"Source",resource_type:"Insights Data Source v3",resource_name:t})),a=Object.entries(o.value).flatMap(([t,j])=>j.map(E=>({type:"Table",resource_type:"Insights Table v3",resource_name:E,table_restrictions:h.value[E]||""}))),s=[...e,...a],b=JSON.stringify(s.map(t=>t.resource_name).filter(Boolean).sort())!==JSON.stringify(c.value.map(t=>t.resource_name).filter(Boolean).sort()),B=JSON.stringify(s.map(t=>t.table_restrictions).filter(Boolean).sort())!==JSON.stringify(c.value.map(t=>t.table_restrictions).filter(Boolean).sort());(b||B)&&(c.value=s)},{debounce:300,deep:!0});const $=d([]);v.getSources().then(e=>{$.value=e.sort((a,s)=>a.title.localeCompare(s.title)),o.value=$.value.reduce((a,s)=>(a[s.name]=a[s.name]||[],a),o.value)});const _=d("");function C(e){n.value===e?n.value=null:(n.value=e,L(e));const a=document.querySelector(`[data-source="${e}"]`);a&&a.scrollIntoView({behavior:"smooth"})}async function L(e){return l.getTables(e,"",0).then(a=>(Object.assign(T.value,{[e]:a}),a))}function I(e){var a,s;return x.value.some(b=>b===e)||((a=o.value[e])==null?void 0:a.length)===((s=T.value[e])==null?void 0:s.length)}function A(e,a){var s;return(s=o.value[e])==null?void 0:s.some(b=>b===a)}function G(e,a){a?(x.value.push(e),n.value===e&&i.value?o.value[e]=i.value.map(s=>s.name):L(e).then(s=>{o.value[e]=s.map(b=>b.name)})):(x.value=x.value.filter(s=>s!==e),o.value[e]=[])}function f(e,a,s){n.value&&(I(e)&&(x.value=x.value.filter(b=>b!==e)),s?o.value[e].push(a):o.value[e]=o.value[e].filter(b=>b!==a))}const w=d(null),O=d([]);Te(()=>[n.value,w.value],()=>{if(!n.value||!w.value)return;const e=T.value[n.value].find(a=>a.name===w.value);e&&l.getTableColumns(n.value,e.table_name).then(a=>{O.value=Ve(a,{label:"name",value:"name",description:"type"})})});function P(e){w.value===e?w.value=null:(h.value[e]=h.value[e]||"",w.value=e)}function J(e){k.value[e]||(k.value[e]=50),k.value[e]+=50}function R(e){return k.value[e]||50}return(e,a)=>{const s=S("FormControl"),b=S("LoadingIndicator"),B=S("Button");return p(!0),V(z,null,X($.value,t=>{var j,E;return p(),V("div",{key:t.name,class:"flex flex-col pr-2","data-source":t.name},[u("div",Je,[m(s,{type:"checkbox",modelValue:I(t.name),"onUpdate:modelValue":r=>G(t.name,r)},null,8,["modelValue","onUpdate:modelValue"]),u("div",{class:"group flex flex-1 cursor-pointer items-center justify-between gap-2",onClick:r=>C(t.name)},[u("div",je,[u("p",ze,M(t.title),1),(j=o.value[t.name])!=null&&j.length?(p(),V("p",qe," ("+M((E=o.value[t.name])==null?void 0:E.length)+" selected) ",1)):D("",!0)]),a[1]||(a[1]=u("hr",{class:"flex-1 border-gray-200"},null,-1)),(p(),N(ve(n.value===t.name?g(Me):g(Ne)),{class:"h-4 w-4 flex-shrink-0 text-gray-600","stroke-width":"1.5"}))],8,Re)]),n.value===t.name?(p(),V("div",Ke,[m(s,{type:"text",placeholder:"Search tables",modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=r=>_.value=r),autocomplete:"off"},{prefix:U(()=>[m(g(Be),{class:"h-4 w-4 text-gray-600","stroke-width":"1.5"})]),suffix:U(()=>[g(l).loading?(p(),N(b,{key:0,class:"h-4 w-4 text-gray-600"})):D("",!0)]),_:1},8,["modelValue"]),(p(!0),V(z,null,X(i.value.filter(r=>r.table_name.toLocaleLowerCase().includes(_.value.toLowerCase())).slice(0,R(t.name)),r=>(p(),V("div",{key:r.name},[u("div",Qe,[u("div",He,[m(s,{type:"checkbox",modelValue:A(t.name,r.name),"onUpdate:modelValue":F=>f(t.name,r.name,F)},null,8,["modelValue","onUpdate:modelValue"]),u("div",{class:"group flex flex-shrink-0 select-none items-baseline gap-2",onClick:F=>f(t.name,r.name,!A(t.name,r.name))},[u("p",We,M(r.table_name),1),A(t.name,r.name)||w.value===r.name||h.value[r.name]?(p(),V("p",{key:0,class:pe(["invisible cursor-pointer text-xs leading-5 text-gray-600 transition-all hover:underline group-hover:visible",w.value===r.name||h.value[r.name]?"!visible":"invisible"]),onClick:fe(F=>P(r.name),["prevent","stop"])},M(w.value===r.name?"Hide":h.value[r.name]?"Edit Filters":"Set Filters"),11,Xe)):D("",!0)],8,Ge)]),w.value===r.name?(p(),V("div",Ye,[m(De,{"column-options":O.value,modelValue:h.value[r.name],"onUpdate:modelValue":F=>h.value[r.name]=F,placeholder:"eg. country == 'India'",class:"h-fit max-h-[10rem] min-h-[2.5rem] text-sm"},null,8,["column-options","modelValue","onUpdate:modelValue"])])):D("",!0)])]))),128)),i.value.length>R(t.name)?(p(),V("div",Ze,[u("p",ea," Showing "+M(R(t.name))+" of "+M(i.value.length)+" tables ",1),m(B,{variant:"ghost",onClick:r=>J(t.name),class:"text-xs"},{default:U(()=>a[2]||(a[2]=[ge(" Load 50 More ")])),_:2},1032,["onClick"])])):D("",!0),i.value.length?D("",!0):(p(),V("div",aa," No tables found "))])):D("",!0)],8,Pe)}),128)}}}),ta={class:"-mb-5 flex h-[25rem] flex-col gap-4 text-base"},sa={class:"flex flex-1 flex-col gap-3 overflow-hidden"},oa={class:"flex w-full flex-shrink-0 gap-2"},na={class:"flex-1"},ia={class:"flex flex-1 flex-col gap-1 overflow-y-auto"},ra={class:"flex flex-1 flex-col"},ua={class:"leading-5"},ma={class:"text-xs text-gray-600"},ca={key:1,class:"rounded border border-dashed border-gray-300 px-32 py-6 text-center text-sm text-gray-500"},da={class:"relative flex flex-1 flex-col gap-1 overflow-y-auto"},va={key:0,class:"rounded bg-gray-50 p-2 text-p-sm text-gray-600"},pa={class:"flex h-32 items-center justify-center"},fa=H({__name:"ManageTeamDialog",props:_e({team:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(y){const c=y,v=ae(y,"modelValue"),l=d(me(c.team)),x=te(),o=Se(),h=le(()=>{if(!l.value)return!1;const $=x.teams.find(_=>_.name===l.value.name);return JSON.stringify($)!==JSON.stringify(l.value)}),n=d("");function T(){!l.value||!n.value||(l.value.team_members.push({user:n.value}),n.value="")}function k($){l.value&&(l.value.team_members=l.value.team_members.filter(_=>_.user!==$))}const i=d("Members");return($,_)=>{const C=S("FormControl"),L=S("Button"),I=S("Avatar"),A=S("LoadingIndicator"),G=S("Dialog");return l.value?(p(),N(G,{key:0,modelValue:v.value,"onUpdate:modelValue":_[4]||(_[4]=f=>v.value=f),options:{title:"Manage Team",actions:[{label:"Done",variant:"solid",disabled:!h.value||g(x).updatingTeam,loading:g(x).updatingTeam,onClick:()=>{l.value&&g(x).updateTeam(l.value).then(()=>{v.value=!1})}}]}},{"body-content":U(()=>[u("div",ta,[m(C,{label:"Team Name",modelValue:l.value.team_name,"onUpdate:modelValue":_[0]||(_[0]=f=>l.value.team_name=f),disabled:l.value.name==="Admin",autocomplete:"off",class:"flex-shrink-0"},null,8,["modelValue","disabled"]),m(ke,{tabs:["Members","Access"],modelValue:i.value,"onUpdate:modelValue":_[1]||(_[1]=f=>i.value=f),class:"flex-shrink-0"},null,8,["modelValue"]),se(u("div",sa,[u("div",oa,[u("div",na,[m(Ce,{placeholder:"Add members",modelValue:n.value,"onUpdate:modelValue":_[2]||(_[2]=f=>n.value=f),"hide-users":l.value.team_members.map(f=>f.user)},null,8,["modelValue","hide-users"])]),m(L,{class:"flex-shrink-0",variant:"solid",label:"Add",disabled:!n.value,onClick:T},null,8,["disabled"])]),u("div",ia,[l.value.team_members.length?(p(!0),V(z,{key:0},X(l.value.team_members,f=>{var w,O,P,J;return p(),V("div",{key:f.user,class:"flex w-full items-center gap-2 py-1"},[m(I,{size:"xl",label:(w=g(o).getUser(f.user))==null?void 0:w.full_name,image:(O=g(o).getUser(f.user))==null?void 0:O.user_image},null,8,["label","image"]),u("div",ra,[u("div",ua,M((P=g(o).getUser(f.user))==null?void 0:P.full_name),1),u("div",ma,M((J=g(o).getUser(f.user))==null?void 0:J.email),1)]),m(L,{variant:"ghost",icon:"x",class:"flex-shrink-0",onClick:R=>k(f.user)},null,8,["onClick"])])}),128)):(p(),V("div",ca," This team does not have any members "))])],512),[[oe,i.value=="Members"]]),se(u("div",da,[l.value.name=="Admin"?(p(),V("div",va," Admin team has access to all the data sources and tables. Members of this team are allowed to manage teams, users, and other admin settings ")):(p(),N(he,{key:1},{fallback:U(()=>[u("div",pa,[m(A,{class:"h-6 w-6 text-gray-600"})])]),default:U(()=>[m(la,{modelValue:l.value.team_permissions,"onUpdate:modelValue":_[3]||(_[3]=f=>l.value.team_permissions=f)},null,8,["modelValue"])]),_:1}))],512),[[oe,i.value=="Access"]])])]),_:1},8,["modelValue","options"])):D("",!0)}}}),ga={class:"flex w-full flex-col gap-6 overflow-y-scroll p-8 px-10"},_a={class:"flex w-full flex-1 flex-col gap-3 overflow-auto"},Pa=H({__name:"PermissionsSettings",setup(y){const c=te();c.getTeams();const v=we();v.load(),ie(()=>v.doc,()=>{v.isdirty&&v.save()},{debounce:500,deep:!0});const l=d(""),x=le(()=>l.value?c.teams.filter(k=>k.team_name.toLowerCase().includes(l.value.toLowerCase())):c.teams),o=d({columns:[{label:"Team Name",key:"team_name",prefix(k){const i=k.row;return m(xe,{size:"md",label:i.team_name},null)}}],rows:x,rowKey:"team_name",options:{selectable:!1,showTooltip:!1,onRowClick:k=>{T.value=me(k),n.value=!0},emptyState:{title:"No teams.",description:"No teams to display.",button:ne.user.is_admin?{label:"Create Team",variant:"solid",onClick:()=>h.value=!0}:void 0}}}),h=d(!1),n=d(!1),T=d(null);return(k,i)=>{const $=S("Toggle"),_=S("Button");return p(),V(z,null,[u("div",ga,[i[5]||(i[5]=u("h1",{class:"text-xl font-semibold"},"Permissions",-1)),m(W,{label:"Enable",description:"Enable permissions to restrict access to data sources & tables based on teams and users."},{default:U(()=>[m($,{modelValue:g(v).doc.enable_permissions,"onUpdate:modelValue":i[0]||(i[0]=C=>g(v).doc.enable_permissions=C)},null,8,["modelValue"])]),_:1}),m(W,{label:"Apply User Permissions",description:"Apply restrictions based on roles and user permissions defined on this site. Only applicable for site data source."},{default:U(()=>[m($,{modelValue:g(v).doc.apply_user_permissions,"onUpdate:modelValue":i[1]||(i[1]=C=>g(v).doc.apply_user_permissions=C)},null,8,["modelValue"])]),_:1}),u("div",_a,[m(W,{label:"Teams",description:"Create teams to group users and manage permissions."},{default:U(()=>[g(ne).user.is_admin?(p(),N(_,{key:0,class:"self-end",label:"New Team",variant:"outline",onClick:i[2]||(i[2]=C=>h.value=!0)},{prefix:U(()=>[m(g(Le),{class:"h-4 w-4 text-gray-700","stroke-width":"1.5"})]),_:1})):D("",!0)]),_:1}),m(g(ye),be({class:"h-full"},o.value),null,16)])]),m(Ie,{modelValue:h.value,"onUpdate:modelValue":i[3]||(i[3]=C=>h.value=C)},null,8,["modelValue"]),T.value?(p(),N(fa,{key:T.value.name,modelValue:n.value,"onUpdate:modelValue":i[4]||(i[4]=C=>n.value=C),team:T.value},null,8,["modelValue","team"])):D("",!0)],64)}}});export{Pa as default};
//# sourceMappingURL=PermissionsSettings-4a0a83dd.js.map
