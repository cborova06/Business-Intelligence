import{j as w,af as K,D as E,c as V,J as we,o as b,b5 as W,H as Se,u as h,s as A,B as Te,v as de,C as D,aI as me,aN as Ee,G as ke,f as _,h as x,w as j,ad as Be,z as H,V as oe,W as ae,ae as Re,aM as Le,aO as $e,E as N,r as L,d as C,K as S,i as Oe,e as $,aV as Ve,y as z,t as O,L as se,M as je,F as I,g as U}from"./frappe-ui-d69b39da.js";import{s as T,F as P,i as Ne,c as pe,b as fe,e as De}from"./index-9194c21d.js";import{s as Fe,c as Ae}from"./toasts-2937f9d2.js";import{s as Pe}from"./router-9009eafe.js";import{c as ve,g as Ie,a as qe}from"./useChartData-3320721f.js";import{_ as Me}from"./TanstackTable-bdba0e34.js";import{j as Qe,p as Ue,a as He,M as ze,c as Je,E as Ke,b as We,s as Ge,T as Xe,d as le,H as Ye,t as p}from"./vue-codemirror.esm-d1d2df5a.js";import{u as Ze}from"./useDataSource-526c5b5a.js";import{u as et}from"./useDataSourceTable-37863c71.js";import{u as ge}from"./dataSourceStore-ae22034f.js";import{_ as tt}from"./Autocomplete-e91e4d1c.js";import{D as nt}from"./index-77f7bd6f.js";import{C as ot}from"./chevron-down-7c5e9308.js";const at={__name:"ContentEditable",props:{tag:{type:String,default:"div"},contenteditable:{type:[Boolean,String],default:!0},disabled:{type:Boolean,default:!1},modelValue:String|Number,value:String|Number,placeholder:String,noHtml:{type:Boolean,default:!0},noNl:{type:Boolean,default:!0}},emits:["returned","update:modelValue","change","blur"],setup(n,{emit:t}){function e(c,i,d){return c.split(i).join(d)}const o=t,a=n,m=w();function u(){var c,i;return a.noHtml?(c=m.value)==null?void 0:c.innerText:(i=m.value)==null?void 0:i.innerHTML}function s(c){a.noHtml?m.value.innerText=c:m.value.innerHTML=c}function l(){return a.value!=null}function r(c){c=="blur"&&o("blur",u()),l()?o("change",u()):o("update:modelValue",u())}function f(c){c.preventDefault();let i=(c.originalEvent||c).clipboardData.getData("text/plain");a.noNl&&(i=e(i,`\r
`," "),i=e(i,`
`," "),i=e(i,"\r"," ")),window.document.execCommand("insertText",!1,i)}function v(c){c.key=="Enter"&&a.noNl&&(c.preventDefault(),o("returned",u()))}return K(()=>{s(l()?a.value:a.modelValue??"")}),E(()=>a.modelValue??a.value,(c,i)=>{c!=u()&&s(c??"")}),E(()=>a.noHtml,(c,i)=>{s(a.modelValue??"")}),E(()=>a.tag,(c,i)=>{s(a.modelValue??"")},{flush:"post"}),(c,i)=>(b(),V(we(n.tag),{class:"contenteditable align-middle outline-none transition-all before:text-gray-500",contenteditable:n.disabled?!1:n.contenteditable,placeholder:n.placeholder,onInput:r,onBlur:i[0]||(i[0]=d=>r("blur")),onPaste:f,onKeypress:v,ref_key:"element",ref:m,spellcheck:"false"},null,40,["contenteditable","placeholder"]))}},wn=at,st={run:"run",store:"store",unstore:"unstore",convert:"convert",setLimit:"set_limit",set_status:"set_status",duplicate:"duplicate",reset:"reset_and_save",fetchTables:"fetch_tables",fetchColumns:"fetch_columns",fetchColumnValues:"fetch_column_values",fetch_related_tables:"fetch_related_tables",addTable:"add_table",removeTable:"remove_table",updateTable:"update_table",fetchJoinOptions:"fetch_join_options",addColumn:"add_column",moveColumn:"move_column",updateColumn:"update_column",removeColumn:"remove_column",updateFilters:"update_filters",addTransform:"add_transform",resetTransforms:"reset_transforms",run:"run",convert_to_native:"convert_to_native",convert_to_assisted:"convert_to_assisted",get_tables_columns:"get_tables_columns",save_as_table:"save_as_table",delete_linked_table:"delete_linked_table",switch_query_type:"switch_query_type"};function lt(n){return n?W({doctype:"Insights Query",name:n,auto:!1,whitelistedMethods:st,transform(e){return e.columns=e.columns.map(o=>(o.format_option=T(o.format_option,{}),o)),e.json=T(e.json,rt),e.transforms=e.transforms.map(o=>(o.options=T(o.options,{}),o)),e}}):void 0}const rt={table:{},joins:[],filters:[],columns:[],calculations:[],measures:[],dimensions:[],orders:[],limit:null};function ut(n){const t=h(()=>{var s;return(s=n.doc)==null?void 0:s.columns.map(l=>({...l,format_option:l.format_option?T(l.format_option):null,aggregation_condition:l.aggregation_condition?T(l.aggregation_condition):null,expression:l.is_expression?T(l.expression):null}))});E(()=>{var s;return(s=n.tables.data)==null?void 0:s.reduce((l,r)=>(l.push(r.table),r.join&&r.join.with.value&&l.push(r.join.with.value),l),[])},(s,l)=>{s!=null&&s.length&&!Ne(s,l)&&n.fetchColumns.submit()},{immediate:!0});const a=h(()=>{var s;return(s=n.fetchColumns.data)==null?void 0:s.map(l=>({...l,value:l.column,description:l.table_label}))});E(a,it);const m=h(()=>n.results.columns.filter(s=>!P.NUMBER.includes(s.type)).map(s=>({label:s.label,value:s.column||s.label}))),u=h(()=>n.results.columns.filter(s=>P.NUMBER.includes(s.type)).map(s=>({label:s.label,value:s.column||s.label})));return{data:t,options:a,indexOptions:m,valueOptions:u}}const J=Se("insights:columns",{});function it(n){J.value=n.reduce((t,e)=>{const o=`${e.table}_${e.column}`;return t[o]||(t[o]=e),t},J.value)}function re(n){return J.value[`${n.table}_${n.column}`]}function q(n){function t(o){return o==="&&"||o==="||"}if(!t(n.operator))return n;function e(o){return o.type=="BinaryExpression"&&t(o.operator)&&n.left&&n.right}if(e(n)){const{left:o,right:a}=n;return n.type="LogicalExpression",n.conditions=n.conditions||[],delete n.left,delete n.right,n.conditions.push(t(o.operator)?q(o):o),n.conditions.push(t(a.operator)?q(a):a),n}return n.type=="LogicalExpression"&&t(n.operator)&&n.conditions.length>0&&n.conditions.forEach((o,a)=>{n.conditions[a]=q(o)}),n}function he(n){if(n.type!=="LogicalExpression"||n.conditions.length==0)return n;function t(e){return e.conditions.some(o=>o.operator==e.operator)}if(t(n)){const e={};n.conditions.forEach((o,a)=>{o.type=="LogicalExpression"&&o.operator==n.operator&&(e[a]=o.conditions)}),Object.keys(e).forEach(o=>{n.conditions.splice(o,1,...e[o])})}return n.conditions.forEach(e=>he(e)),n}function ct(n){function t(e){var o;return(o=e.conditions)==null||o.forEach((a,m)=>{a.type=="LogicalExpression"&&(a.level=e.level+1,a.position=m+1,a.conditions.length>0&&t(a))}),e}return n.level=1,n.position=1,t(n)}function dt(n){if(n.type!=="LogicalExpression")return n;let t=n;return t=q(t),t=he(t),t=ct(t),t}const mt={type:"LogicalExpression",level:1,position:1,operator:"&&",conditions:[]};function pt(n){const t=h(()=>T(n.doc.filters,mt)),e=A({level:1,position:1}),o=A({level:1,position:1,idx:-1}),a=r=>{F({...e,filters:t.value}).conditions.push(r),l()},m=r=>{const f=F({...o,filters:t.value});f.conditions[o.idx]=r,Object.assign(o,{level:1,position:1,idx:-1}),l()},u=(r,f,v)=>{r==1&&typeof v=="number"&&t.value.conditions.splice(v,1),r>1&&f&&typeof v=="number"&&F({filters:t.value,level:r,position:f}).conditions.splice(v,1),l()},s=(r,f)=>{const v=F({filters:t.value,level:r,position:f});v.operator=v.operator=="&&"?"||":"&&",l()},l=()=>{let r=dt(t.value);n.updateFilters.submit({filters:r})};return{data:t,addNextFilterAt:e,editFilterAt:o,add:a,edit:m,remove:u,toggleOperator:s,convertIntoExpression:gt,convertIntoSimpleFilter:xe,isSimpleFilter:yt}}function F({filters:n,level:t,position:e,parentIdx:o}){var m;if(t==1&&e==1)return n;let a=null;for(let u=0;u<n.conditions.length;u++){let s=n.conditions[u];if(s.type==="LogicalExpression"){if(s.level==t&&(s.position==e||u==o)){a=s;break}if(((m=s.conditions)==null?void 0:m.length)>0){let l=F({filters:s,level:t,position:e});if(l){a=l;break}}}}return a}const _e={"=":"equals","!=":"not equals",">":"greater than",">=":"greater than equal to","<":"less than","<=":"less than equal to"},G={is:"is",in:"one of",not_in:"not one of",between:"between",timespan:"within",starts_with:"starts with",ends_with:"ends with",contains:"contains",not_contains:"not contains"};function ye(n){return G[n]?n:n.indexOf("set")>-1?"is":null}function be(n){return!!_e[n]}function Ce(n){return!!G[ye(n)]}function ft(n){const{column:t,operator:e,value:o}=n;return{type:"BinaryExpression",operator:e.value,left:{type:"Column",value:{column:t.column,table:t.table}},right:{type:P.NUMBER.includes(t.type)?"Number":"String",value:o.value}}}function vt(n){const{column:t,operator:e,value:o}=n,a=e.value=="is"?o.value=="set"?"is_set":"is_not_set":e.value;function m(){return e.value=="is"?[]:e.value=="between"?o.value.split(",").map(s=>({type:P.NUMBER.includes(t.type)?"Number":"String",value:s})):["in","not_in"].includes(e.value)?o.value.map(u=>({type:"String",value:u})):[{type:"String",value:o.value}]}return{type:"CallExpression",function:a,arguments:[{type:"Column",value:{column:t.column,table:t.table}},...m()]}}function gt(n){const t=n.operator.value;if(be(t))return ft(n);if(Ce(t))return vt(n)}function ht(n){return n.every(t=>t.type=="String"||t.type=="Number")}function _t(n){if(!ht(n.arguments.slice(1)))return[];if(n.function=="is_set")return["Set","Set"];if(n.function=="is_not_set")return["Not Set","Not Set"];if(n.function=="between"){const e=n.arguments[1].value+", "+n.arguments[2].value;return[e,e]}if(["in","not_in"].includes(n.function)){const e=n.arguments.slice(1).map(a=>a.value);return[e.length>1?e.length+" values":e[0],e]}const t=n.arguments[1].value;return[t,t]}function yt(n){const t=xe(n);if(!t)return!1;const{column:e,operator:o,value:a}=t;return!(!e||!o||!a||!e.value||!o.value||!a.value)}function xe(n){if(be(n.operator)){const t=re(n.left.value),e={label:_e[n.operator],value:n.operator},o={label:n.right.value,value:n.right.value};return{column:t,operator:e,value:o}}if(Ce(n.function)){const t=ye(n.function),e=re(n.arguments[0].value),[o,a]=_t(n);return{column:e,operator:{label:G[t],value:t},value:{label:o||a,value:a}}}}function bt(n){n.fetchTables.submit();const t=h(()=>{var m;return(m=n.doc)==null?void 0:m.tables.map(u=>({...u,value:u.table,join:u.join?T(u.join):null}))}),e=h(()=>{var m;return(m=n.fetchTables.data)==null?void 0:m.filter(u=>u.table!=n.doc.name).map(u=>({...u,value:u.table,description:u.is_query_based?"Query":""}))}),o=h(()=>e.value),a=h(()=>{var s,l,r,f;if(((l=(s=n.doc)==null?void 0:s.tables)==null?void 0:l.length)==0)return e.value;const m=(r=n.doc)==null?void 0:r.tables.map(v=>({label:v.label,value:v.table})),u=(f=n.doc)==null?void 0:f.tables.reduce((v,c)=>{if(c.join){const i=T(c.join);v.push({label:i.with.label,value:i.with.table})}return v},[]);return[...m,...u]});return{data:t,newTableOptions:a,joinOptions:o,validateRemoveTable({table:m,label:u}){const s=n.doc.columns.filter(r=>r.table===m),l=n.doc.tables.filter(r=>r.table===m).length;if(s.length>0&&l==1)return{title:"Cannot remove table",message:`Remove dimensions and metrics associated with ${u} table and try again`,variant:"warning"}}}}function Ct(n,t,e){const o=xt(n);o.get.fetch();const a=A({doc:h(()=>o.doc||{}),data:h(()=>ve(e.formattedResults)),togglePublicAccess:r,addToDashboard:f,getGuessedChart:l,resetOptions:v,delete:c}),m=pe();Te(()=>({chart_type:a.doc.chart_type,options:a.doc.options}),u,{deep:!0,debounce:1e3});async function u(i){const d=o.originalDoc,g=i.chart_type!=d.chart_type,y=!fe(i.options,d.options);if(!g&&!y)return;let k={...i.options};k.query||(k.query=a.doc.query),g&&i.chart_type!="Auto"&&(k={...l(i.chart_type).options,...k},k.title=t),s({chart_type:i.chart_type,options:k})}function s(i){return i.options.query=a.doc.query,m(()=>o.setValue.submit({title:i.options.title||t,chart_type:i.chart_type,options:i.options}))}function l(i){var g;if(!e.formattedResults.length)return;i=i||a.doc.chart_type;const d=Ie(e.formattedResults,i);return{chart_type:d==null?void 0:d.type,options:{...d==null?void 0:d.options,title:((g=d==null?void 0:d.options)==null?void 0:g.title)||t}}}function r(i){o.doc.is_public!==i&&o.setValue.submit({is_public:i}).then(()=>{$notify({title:"Chart access updated",variant:"success"}),o.doc.is_public=i})}async function f(i){if(!(!i||!o.doc.name||o.addingToDashboard)){if(o.addingToDashboard=!0,a.doc.chart_type=="Auto"){const d=l();await s({chart_type:d.chart_type,options:d.options})}await de("insights.api.dashboards.add_chart_to_dashboard",{dashboard:i,chart:o.doc.name}),o.addingToDashboard=!1}}function v(){state.doc.chart_type=void 0,state.doc.options={}}async function c(){return state.deleting=!0,m(()=>o.delete.submit().then(()=>state.deleting=!1))}return a}function xt(n){return W({doctype:"Insights Chart",name:n,auto:!1,transform:t=>(t.chart_type=t.chart_type,t.options=T(t.options),t)})}function wt(n){const t=St(n);return t.get.fetch(),A({reload:()=>t.get.fetch(),loading:h(()=>t.loading),data:h(()=>{var e;return((e=t.doc)==null?void 0:e.results)||[]}),columns:h(()=>{var e,o;return((o=(e=t.doc)==null?void 0:e.results)==null?void 0:o[0])||[]}),formattedResults:h(()=>{var e;return qe((e=t.doc)==null?void 0:e.results)})})}function St(n){return W({doctype:"Insights Query Result",name:n,auto:!1,transform:t=>(t.results=T(t.results,[]),t)})}const Tt=Fe();function Sn(n){const t=lt(n),e=A({loading:!0,executing:!1,doc:{},chart:{},results:{},sourceSchema:{}}),o=pe();e.doc=h(()=>t.doc);const a=l=>e.loading=l;e.MAX_ROWS=100,e.isOwner=h(()=>{var l;return((l=t.doc)==null?void 0:l.owner)===Tt.user.email}),e.reload=()=>(a(!0),t.get.fetch().then(()=>m()).finally(()=>a(!1)));async function m(){e.doc.result_name&&(e.results=wt(e.doc.result_name)),e.doc.chart&&(e.chart=Ct(e.doc.chart,e.doc.title,e.results))}e.updateTitle=l=>(a(!0),o(()=>t.setValue.submit({title:l}).finally(()=>a(!1)))),e.changeDataSource=l=>(a(!0),o(()=>t.setValue.submit({data_source:l}).then(()=>a(!1))));const u=Pe().settings.auto_execute_query;e.updateQuery=async l=>fe(l,t.originalDoc.json)?Promise.resolve({query_updated:!1}):(a(!0),new Promise(r=>o(()=>t.setValue.submit({json:JSON.stringify(l,null,2)}).then(()=>u&&e.execute()).then(()=>r({query_updated:!0})).finally(()=>a(!1))))),e.execute=D(async()=>{var l;(l=e.doc)!=null&&l.data_source&&(a(!0),e.executing=!0,await o(()=>t.run.submit().catch(()=>{})),await e.results.reload(),e.executing=!1,a(!1))},500),e.updateTransforms=D(async l=>{if(!l)return;a(!0);const r=()=>t.setValue.submit({transforms:l}),f=()=>t.set_status.submit({status:"Pending Execution"}),v=()=>u&&e.execute();return o(()=>r().then(f).then(v).finally(()=>a(!1)))},500),e.duplicate=async()=>(e.duplicating=!0,await o(()=>t.duplicate.submit()),e.duplicating=!1,t.duplicate.data),e.delete=async()=>{e.deleting=!0,await o(()=>t.delete.submit()),e.deleting=!1},e.store=()=>(a(!0),o(()=>t.store.submit().finally(()=>a(!1)))),e.unstore=()=>(a(!0),o(()=>t.unstore.submit().finally(()=>a(!1)))),e.switchQueryBuilder=()=>o(()=>t.switch_query_type.submit().then(()=>{window.location.reload()}));const s=h(()=>{var l,r,f;return t.doc?!((l=t.doc)!=null&&l.is_assisted_query)&&!((r=t.doc)!=null&&r.is_native_query)&&!((f=t.doc)!=null&&f.is_script_query):!1});return me(s,()=>{e.classicQueryInitialized||!s.value||(e.addTable=t.addTable,e.fetchTables=t.fetchTables,e.updateTable=t.updateTable,e.removeTable=t.removeTable,e.fetchJoinOptions=t.fetchJoinOptions,e.tables=bt(e),e.addColumn=t.addColumn,e.moveColumn=t.moveColumn,e.removeColumn=t.removeColumn,e.updateColumn=t.updateColumn,e.fetchColumns=t.fetchColumns,e.columns=ut(e),e.updateFilters=t.updateFilters,e.fetchColumnValues=t.fetchColumnValues,e.filters=pt(e),e.classicQueryInitialized=!0)}),e.convertToNative=async()=>{if(!e.doc.is_native_query)return a(!0),o(()=>t.setValue.submit({is_native_query:1,is_assisted_query:0,is_script_query:0}).finally(()=>a(!1)))},e.executeSQL=D(l=>!l||l===e.doc.sql?e.execute():(a(!0),o(()=>t.setValue.submit({sql:l}).then(()=>e.execute()).finally(()=>a(!1)))),500),e.updateScript=D(l=>{if(l!==e.doc.script)return a(!0),o(()=>t.setValue.submit({script:l}).finally(()=>a(!1)))},500),e.updateScriptVariables=D(l=>(a(!0),o(()=>t.setValue.submit({variables:l}).finally(()=>{Ae({title:"Secret Variables Updated"}),a(!1)}))),500),e.downloadResults=()=>{var d;const l=(d=e.results)==null?void 0:d.data;if(!l||l.length===0)return;let r=[...l];if(r.length===0)return;r[0]=r[0].map(g=>g.label);const f=r.map(g=>g.map(y=>(typeof y=="string"&&(y.includes('"')&&(y=y.replace(/"/g,'""')),(y.includes(`
`)||y.includes(",")||y.includes('"'))&&(y=`"${y}"`)),y)).join(",")).join(`
`),v=new Blob([f],{type:"text/csv"}),c=window.URL.createObjectURL(v),i=document.createElement("a");i.setAttribute("hidden",""),i.setAttribute("href",c),i.setAttribute("download",`${e.doc.title||"data"}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i)},e}const Et={enterActiveClass:"transition duration-200 ease-out",leaveActiveClass:"transition duration-150 ease-in",enterFromClass:"translate-y-1 opacity-0",enterToClass:"translate-y-0 opacity-100",leaveFromClass:"translate-y-0 opacity-100",leaveToClass:"translate-y-1 opacity-0"},Tn={enterActiveClass:"transition duration-200 ease-out",leaveActiveClass:"transition duration-150 ease-in",enterFromClass:"translate-x-1 opacity-0",enterToClass:"translate-x-0 opacity-100",leaveFromClass:"translate-x-0 opacity-100",leaveToClass:"translate-x-1 opacity-0"},En={__name:"UsePopover",props:{show:{type:Boolean,default:void 0},placement:{type:String,default:"bottom-start"},targetElement:{type:Object,required:!0},transition:{type:Object,default:Et},autoClose:{type:Boolean,default:!0}},emits:["update:show"],setup(n,{expose:t,emit:e}){const o=e,a=n,m=a.show!==void 0,u=w(!1),s=h({get:()=>m?a.show:u.value,set:g=>m?o("update:show",g):u.value=g});if(!document.getElementById("frappeui-popper-root")){const g=document.createElement("div");g.id="frappeui-popper-root",document.body.appendChild(g)}let l=null;const r=w(null),f=()=>s.value=!s.value,v=()=>s.value=!0,c=()=>s.value=!1;K(()=>{if(!a.targetElement){console.warn("Popover: targetElement is required");return}l=Ee(a.targetElement,r.value,{placement:a.placement,modifiers:[{name:"offset",options:{offset:[0,8]}}]}),d(),window.addEventListener("resize",d),window.addEventListener("scroll",d),a.targetElement.addEventListener("click",v),a.targetElement.addEventListener("focus",v),a.autoClose&&document.addEventListener("click",i)});const i=g=>{r.value.contains(g.target)||a.targetElement.contains(g.target)||document.getElementById("frappeui-popper-root").contains(g.target)||c()},d=()=>s.value&&(l==null?void 0:l.update());return me(s,d),ke(()=>{l==null||l.destroy(),window.removeEventListener("resize",d),window.removeEventListener("scroll",d),a.targetElement.removeEventListener("click",f),a.targetElement.removeEventListener("focus",v),a.autoClose&&document.removeEventListener("click",i)}),t({toggle:f,open:v,close:c,isOpen:s}),(g,y)=>(b(),V($e,{to:"#frappeui-popper-root"},[_("div",{ref_key:"popover",ref:r,class:"z-[100]"},[x(Le,oe(ae(n.transition)),{default:j(()=>[Be(_("div",null,[H(g.$slots,"default",oe(ae({toggle:f})))],512),[[Re,s.value]])]),_:3},16)],512)]))}},kt={class:"relative flex h-full w-full flex-col overflow-hidden rounded border"},Bt={key:0,class:"absolute top-8 z-10 flex h-[calc(100%-2rem)] w-full items-center justify-center rounded bg-gray-50/30 backdrop-blur-sm"},Rt={class:"flex flex-1 flex-col items-center justify-center gap-2"},Lt={key:1,class:"border-t p-1"},kn={__name:"ResultSection",setup(n){const t=N("query"),e=h(()=>t.doc.status=="Pending Execution"),o=h(()=>{var u,s;return((s=(u=t.results)==null?void 0:u.formattedResults)==null?void 0:s.length)>0}),a=h(()=>ve(t.results.formattedResults)),m=h(()=>{var l;if(!((l=t.results.columns)!=null&&l.length))return[];const u={id:"__index",header:"#",accessorKey:"__index",cell:r=>r.row.index+1},s=t.results.columns.map(r=>{const f=P.NUMBER.includes(r.type);return{id:r.label,header:r.label,accessorKey:r.label,enableSorting:!1,isNumber:f,cell:v=>{const c=v.getValue();return f?De(c):c}}});return[u,...s]});return(u,s)=>{const l=L("Button");return b(),C("div",kt,[e.value||S(t).executing?(b(),C("div",Bt,[_("div",Rt,[x(l,{class:"shadow-2xl",variant:"solid",onClick:s[0]||(s[0]=r=>S(t).execute()),loading:S(t).executing},{default:j(()=>s[1]||(s[1]=[Oe(" Execute Query ")])),_:1},8,["loading"])])])):$("",!0),x(Me,{class:z(e.value?"pointer-events-none":""),data:a.value,columns:m.value,showPagination:!1},Ve({_:2},[u.$slots.columnActions?{name:"columnActions",fn:j(({column:r})=>[r.id!="index"?H(u.$slots,"columnActions",{key:0,column:{label:r.id}}):$("",!0)]),key:"0"}:void 0]),1032,["class","data","columns"]),u.$slots.footer&&o.value?(b(),C("div",Lt,[H(u.$slots,"footer")])):$("",!0)])}}},$t={class:"flex items-center justify-between rounded-b-md px-1 text-base"},Ot={key:0,class:"flex items-center space-x-1"},Vt={class:"tnum"},jt={class:"tnum"},Nt={class:"tnum"},Dt={class:"ml-auto flex items-center gap-1"},Bn={__name:"ResultFooter",setup(n){const t=N("query"),e=h(()=>t.doc.execution_time),o=h(()=>t.doc.results_row_count),a=h(()=>Math.min(t.MAX_ROWS,o.value));return(m,u)=>{const s=L("Button");return b(),C("div",$t,[o.value>=0?(b(),C("div",Ot,[u[0]||(u[0]=_("span",{class:"text-gray-600"},"Showing",-1)),_("span",Vt,O(a.value),1),u[1]||(u[1]=_("span",{class:"text-gray-600"},"out of",-1)),_("span",jt,O(o.value),1),u[2]||(u[2]=_("span",{class:"text-gray-600"},"rows in",-1)),_("span",Nt,O(e.value),1),u[3]||(u[3]=_("span",{class:"text-gray-600"},"seconds",-1))])):$("",!0),_("div",Dt,[x(s,{variant:"ghost",icon:"download",onClick:S(t).downloadResults},null,8,["onClick"])])])}}},Ft="#e5a05b",ue="#b04a54",At="#45a5b1",Pt="#ffffff",It="#6a6a6a",ie="#7d8799",qt="#61afef",Mt="#76c457",ce="#d19a66",Qt="#c678dd",Ut={__name:"Code",props:se({modelValue:String,readOnly:{type:Boolean,default:!1},autofocus:{type:Boolean,default:!0},placeholder:{type:String,default:"Enter an expression..."},completions:{type:Function,default:null},language:{type:String,default:"javascript"},tables:{type:Array,default:()=>[]},schema:{type:Object,default:()=>({})},hideLineNumbers:{type:Boolean,default:!1},disableAutocompletions:{type:Boolean,default:!1}},{modelValue:{},modelModifiers:{}}),emits:se(["inputChange","viewUpdate","focus","blur"],["update:modelValue"]),setup(n,{expose:t,emit:e}){const o=n,a=e;K(()=>{o.hideLineNumbers&&document.querySelectorAll(".cm-gutters").forEach(c=>{c.style.display="none"})});const m=c=>{a("viewUpdate",{cursorPos:c.state.selection.ranges[0].to,syntaxTree:le(c.state),state:c.state})},u=w(null),s=je(n,"modelValue");E(s,(c,i)=>{c!==i&&a("inputChange",c)});const r=[o.language==="javascript"?Qe():o.language==="python"?Ue():He({dialect:ze,upperCaseKeywords:!0,schema:o.schema,tables:o.tables}),Je(),Ke.lineWrapping],f={activateOnTyping:!0,closeOnBlur:!1,maxRenderedOptions:10,icons:!1,optionClass:()=>"flex h-7 !px-2 items-center rounded !text-gray-600"};o.completions&&(f.override=[c=>o.completions(c,le(c.state))]),r.push(We(f));const v=()=>Ye.define([{tag:p.keyword,color:Qt},{tag:[p.name,p.deleted,p.character,p.propertyName,p.macroName],color:ue},{tag:[p.function(p.variableName),p.labelName],color:qt},{tag:[p.color,p.constant(p.name),p.standard(p.name)],color:ce},{tag:[p.definition(p.name),p.separator],color:It},{tag:[p.typeName,p.className,p.number,p.changed,p.annotation,p.modifier,p.self,p.namespace],color:Ft},{tag:[p.operator,p.operatorKeyword,p.url,p.escape,p.regexp,p.link,p.special(p.string)],color:At},{tag:[p.meta,p.comment],color:ie},{tag:p.strong,fontWeight:"bold"},{tag:p.emphasis,fontStyle:"italic"},{tag:p.strikethrough,textDecoration:"line-through"},{tag:p.link,color:ie,textDecoration:"underline"},{tag:p.heading,fontWeight:"bold",color:ue},{tag:[p.atom,p.bool,p.special(p.variableName)],color:ce},{tag:[p.processingInstruction,p.string,p.inserted],color:Mt},{tag:p.invalid,color:Pt}]);return r.push(Ge(v())),t({get cursorPos(){return u.value.view.state.selection.ranges[0].to},focus:()=>u.value.view.focus(),setCursorPos:c=>{const i=Math.min(c,s.value.length);u.value.view.dispatch({selection:{anchor:i,head:i}})}}),(c,i)=>(b(),V(S(Xe),{"tab-size":2,disabled:n.readOnly,modelValue:s.value,"onUpdate:modelValue":i[0]||(i[0]=d=>s.value=d),class:"font-[400]",autofocus:n.autofocus,"indent-with-tab":!0,extensions:r,placeholder:n.placeholder,onUpdate:m,onFocus:i[1]||(i[1]=d=>a("focus")),onBlur:i[2]||(i[2]=d=>a("blur")),onReady:i[3]||(i[3]=d=>u.value=d)},null,8,["disabled","modelValue","autofocus","placeholder"]))}},Ht={class:"-ml-2 h-[32rem] w-full overflow-y-auto overflow-x-hidden overflow-y-hidden pl-2"},zt={class:"flex flex-col gap-1"},Jt=["onClick"],Kt={class:"flex items-center gap-2"},Wt={class:"font-medium leading-6 text-gray-900"},Gt={key:0,class:"mt-1 flex flex-col gap-1"},Xt=["onClick"],Yt={class:"flex items-center gap-2"},Zt={class:"font-medium leading-6 text-gray-900"},en={key:0,class:"mt-1 ml-4 mb-1 flex items-center justify-center"},tn={key:1,class:"w-full space-y-2"},nn={class:"flex items-center space-x-2 pl-2"},on={class:"font-medium leading-6 text-gray-900"},an={__name:"SchemaExplorerDialog",props:{show:Boolean},emits:["update:show"],setup(n,{emit:t}){const e=t,o=n,a=h({get:()=>o.show,set:d=>e("update:show",d)}),m=h(()=>ge().list.map(d=>({title:d.title,name:d.name}))),u=w([]),s=w([]),l=N("query"),r=w(null);E(()=>{var d;return(d=l==null?void 0:l.doc)==null?void 0:d.data_source},d=>{d&&(r.value={name:d})},{immediate:!0});const f=w(null);E(r,()=>{if(!r.value)return;u.value=[],s.value=[],Ze(r.value.name).fetchTables().then(g=>{u.value=g.map(y=>({label:y.label,table:y.table,name:y.name}))})},{immediate:!0});const v=w(!1);E(f,async()=>{if(!f.value)return;s.value=[],v.value=!0;const d=await et({name:f.value.name});v.value=!1,s.value=d.columns.map(g=>({label:g.label,column:g.column,type:g.type}))},{immediate:!0});function c(d){var g;((g=r.value)==null?void 0:g.name)==d.name?r.value=null:r.value=d}function i(d){var g;((g=f.value)==null?void 0:g.name)==d.name?f.value=null:f.value=d}return(d,g)=>{const y=L("FeatherIcon"),k=L("LoadingIndicator"),M=L("Dialog");return b(),V(M,{modelValue:a.value,"onUpdate:modelValue":g[0]||(g[0]=B=>a.value=B),options:{title:"Browse Data Sources"}},{"body-content":j(()=>[_("div",Ht,[_("div",zt,[(b(!0),C(I,null,U(m.value,B=>{var X,Y,Z;return b(),C("div",{key:B.name,class:"flex cursor-pointer flex-col space-x-4"},[_("div",{class:z(["-ml-1 flex flex-1 cursor-pointer items-center gap-2 rounded py-1 pl-1 transition-colors hover:bg-gray-100",((X=r.value)==null?void 0:X.name)==B.name&&!f.value?"bg-gray-100":""]),onClick:R=>c(B)},[x(y,{name:((Y=r.value)==null?void 0:Y.name)==B.name?"minus":"plus",class:"h-4 w-4"},null,8,["name"]),_("div",Kt,[x(y,{name:"database",class:"h-4 w-4 text-gray-600"}),_("p",Wt,O(B.title),1)])],10,Jt),((Z=r.value)==null?void 0:Z.name)==B.name?(b(),C("div",Gt,[(b(!0),C(I,null,U(u.value,R=>{var ee,te,ne;return b(),C("div",{key:R.name,class:"pl-2"},[_("div",{class:z(["-ml-1 flex flex-1 cursor-pointer items-center gap-2 rounded py-1 pl-1 transition-colors hover:bg-gray-100",((ee=f.value)==null?void 0:ee.name)==R.name?"bg-gray-100":""]),onClick:Q=>i(R)},[x(y,{name:((te=f.value)==null?void 0:te.name)==R.name?"minus":"plus",class:"h-4 w-4"},null,8,["name"]),_("div",Yt,[x(y,{name:"folder",class:"h-4 w-4 text-gray-600"}),_("p",Zt,O(R.label),1)])],10,Xt),((ne=f.value)==null?void 0:ne.name)==R.name?(b(),C("div",en,[v.value?(b(),V(k,{key:0,class:"w-6 text-gray-600"})):(b(),C("div",tn,[(b(!0),C(I,null,U(s.value,Q=>(b(),C("div",{key:Q.column},[_("div",nn,[x(y,{name:"type",class:"h-4 w-4 text-gray-600"}),_("p",on,O(Q.label),1)])]))),128))]))])):$("",!0)])}),128))])):$("",!0)])}),128))])])]),_:1},8,["modelValue"])}}},sn={class:"relative flex flex-1 flex-col overflow-y-auto"},ln={key:0,class:"sticky bottom-0 flex gap-1 border-t bg-white p-1"},Rn={__name:"NativeQueryEditor",props:{showToolbar:{type:Boolean,default:!0}},setup(n){const t=n,e=N("query");e.doc.data_source&&de("run_doc_method",{method:"get_schema",dt:"Insights Data Source",dn:e.doc.data_source}).then(u=>{e.sourceSchema=u.message});const o=h(()=>{if(!e.sourceSchema)return{schema:{},tables:[]};const u={};Object.entries(e.sourceSchema).forEach(([l,r])=>{u[l]=r.columns.map(f=>({label:f.column,detail:f.label}))});const s=Object.entries(e.sourceSchema).map(([l,r])=>({label:l,detail:r.label}));return{schema:u,tables:s}}),a=w(!1),m=w(e.doc.sql);return E(()=>e.doc.sql,u=>m.value=u),(u,s)=>{const l=L("Button");return b(),C(I,null,[_("div",sn,[(b(),V(Ut,{key:o.value.tables.length,language:"sql",modelValue:m.value,"onUpdate:modelValue":s[0]||(s[0]=r=>m.value=r),schema:o.value.schema,tables:o.value.tables,placeholder:"Type your query here"},null,8,["modelValue","schema","tables"])),t.showToolbar?(b(),C("div",ln,[_("div",null,[x(l,{variant:"outline",iconLeft:"book-open",onClick:s[1]||(s[1]=r=>a.value=!a.value),label:"Tables"})]),_("div",null,[x(l,{variant:S(e).doc.status!=="Execution Successful"?"solid":"outline",iconLeft:"play",onClick:s[2]||(s[2]=r=>S(e).executeSQL(m.value)),loading:S(e).loading,label:"Run"},null,8,["variant","loading"])])])):$("",!0)]),x(an,{show:a.value,"onUpdate:show":s[3]||(s[3]=r=>a.value=r)},null,8,["show"])],64)}}},rn={class:"flex items-center gap-2"},un={class:"truncate"},Ln={__name:"QueryDataSourceSelector",setup(n){const t=N("$notify"),e=N("query"),o=ge(),a=h(()=>o.list.find(s=>s.name===e.doc.data_source)),m=h(()=>o.list.map(s=>({label:s.title,value:s.name})));function u(s){e.changeDataSource(s).then(()=>{t({title:"Data source updated",variant:"success"})})}return(s,l)=>{const r=L("Button"),f=tt;return b(),V(f,{options:m.value,modelValue:S(e).doc.data_source,"onUpdate:modelValue":l[0]||(l[0]=v=>u(v.value))},{target:j(({togglePopover:v})=>[x(r,{variant:"outline",onClick:v},{default:j(()=>{var c;return[_("div",rn,[x(S(nt),{class:"h-4 w-4 text-gray-600"}),_("span",un,O(((c=a.value)==null?void 0:c.title)||"Select data source"),1),x(S(ot),{class:"h-4 w-4 text-gray-600"})])]}),_:2},1032,["onClick"])]),_:1},8,["options","modelValue"])}}};export{wn as C,En as _,Rn as a,kn as b,Ut as c,Ln as d,Bn as e,Tn as s,Sn as u};
//# sourceMappingURL=QueryDataSourceSelector-8ecc9714.js.map
