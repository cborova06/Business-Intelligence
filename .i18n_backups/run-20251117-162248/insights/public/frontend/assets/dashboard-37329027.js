import{u as ue,s as Me,ao as Oe,v as _e,j as ne,b3 as vt,K as Ut,q as Lt,a$ as Rt,D as qt}from"./frappe-ui-d69b39da.js";import{h as me,s as Ge,y as Te,q as ve,i as Je,L as Se,e as de,b as we,f as se,p as He,g as ce,w as he,M as Mt,N as Ot,O as Tt,P as Nt,Q as $t,R as rt,T as nt,U as je,V as ot,W as it,X as at,Y as zt,Z as st,$ as ut,j as fe,a0 as lt,a1 as Qt,a2 as ct,a3 as Yt,a4 as Vt,a5 as dt,a6 as Wt,F as Z,k as jt,v as ge,a7 as ft,t as Pe,a8 as Pt,a9 as Gt,B as Jt,K as Ht,aa as Xt}from"./main-d2d228fc.js";var xt={},Ne={};Ne.byteLength=er;Ne.toByteArray=rr;Ne.fromByteArray=ir;var le=[],ie=[],Zt=typeof Uint8Array<"u"?Uint8Array:Array,Ve="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ae=0,Kt=Ve.length;Ae<Kt;++Ae)le[Ae]=Ve[Ae],ie[Ve.charCodeAt(Ae)]=Ae;ie["-".charCodeAt(0)]=62;ie["_".charCodeAt(0)]=63;function gt(n){var r=n.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=n.indexOf("=");s===-1&&(s=r);var c=s===r?0:4-s%4;return[s,c]}function er(n){var r=gt(n),s=r[0],c=r[1];return(s+c)*3/4-c}function tr(n,r,s){return(r+s)*3/4-s}function rr(n){var r,s=gt(n),c=s[0],f=s[1],h=new Zt(tr(n,c,f)),d=0,a=f>0?c-4:c,m;for(m=0;m<a;m+=4)r=ie[n.charCodeAt(m)]<<18|ie[n.charCodeAt(m+1)]<<12|ie[n.charCodeAt(m+2)]<<6|ie[n.charCodeAt(m+3)],h[d++]=r>>16&255,h[d++]=r>>8&255,h[d++]=r&255;return f===2&&(r=ie[n.charCodeAt(m)]<<2|ie[n.charCodeAt(m+1)]>>4,h[d++]=r&255),f===1&&(r=ie[n.charCodeAt(m)]<<10|ie[n.charCodeAt(m+1)]<<4|ie[n.charCodeAt(m+2)]>>2,h[d++]=r>>8&255,h[d++]=r&255),h}function nr(n){return le[n>>18&63]+le[n>>12&63]+le[n>>6&63]+le[n&63]}function or(n,r,s){for(var c,f=[],h=r;h<s;h+=3)c=(n[h]<<16&16711680)+(n[h+1]<<8&65280)+(n[h+2]&255),f.push(nr(c));return f.join("")}function ir(n){for(var r,s=n.length,c=s%3,f=[],h=16383,d=0,a=s-c;d<a;d+=h)f.push(or(n,d,d+h>a?a:d+h));return c===1?(r=n[s-1],f.push(le[r>>2]+le[r<<4&63]+"==")):c===2&&(r=(n[s-2]<<8)+n[s-1],f.push(le[r>>10]+le[r>>4&63]+le[r<<2&63]+"=")),f.join("")}var Xe={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Xe.read=function(n,r,s,c,f){var h,d,a=f*8-c-1,m=(1<<a)-1,I=m>>1,g=-7,k=s?f-1:0,R=s?-1:1,B=n[r+k];for(k+=R,h=B&(1<<-g)-1,B>>=-g,g+=a;g>0;h=h*256+n[r+k],k+=R,g-=8);for(d=h&(1<<-g)-1,h>>=-g,g+=c;g>0;d=d*256+n[r+k],k+=R,g-=8);if(h===0)h=1-I;else{if(h===m)return d?NaN:(B?-1:1)*(1/0);d=d+Math.pow(2,c),h=h-I}return(B?-1:1)*d*Math.pow(2,h-c)};Xe.write=function(n,r,s,c,f,h){var d,a,m,I=h*8-f-1,g=(1<<I)-1,k=g>>1,R=f===23?Math.pow(2,-24)-Math.pow(2,-77):0,B=c?0:h-1,V=c?1:-1,P=r<0||r===0&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(a=isNaN(r)?1:0,d=g):(d=Math.floor(Math.log(r)/Math.LN2),r*(m=Math.pow(2,-d))<1&&(d--,m*=2),d+k>=1?r+=R/m:r+=R*Math.pow(2,1-k),r*m>=2&&(d++,m/=2),d+k>=g?(a=0,d=g):d+k>=1?(a=(r*m-1)*Math.pow(2,f),d=d+k):(a=r*Math.pow(2,k-1)*Math.pow(2,f),d=0));f>=8;n[s+B]=a&255,B+=V,a/=256,f-=8);for(d=d<<f|a,I+=f;I>0;n[s+B]=d&255,B+=V,d/=256,I-=8);n[s+B-V]|=P*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(n){var r=Ne,s=Xe,c=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;n.Buffer=a,n.SlowBuffer=W,n.INSPECT_MAX_BYTES=50;var f=2147483647;n.kMaxLength=f,a.TYPED_ARRAY_SUPPORT=h(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function h(){try{var o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function d(o){if(o>f)throw new RangeError('The value "'+o+'" is invalid for option "size"');var e=new Uint8Array(o);return Object.setPrototypeOf(e,a.prototype),e}function a(o,e,t){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return k(o)}return m(o,e,t)}a.poolSize=8192;function m(o,e,t){if(typeof o=="string")return R(o,e);if(ArrayBuffer.isView(o))return V(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(oe(o,ArrayBuffer)||o&&oe(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(oe(o,SharedArrayBuffer)||o&&oe(o.buffer,SharedArrayBuffer)))return P(o,e,t);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var i=o.valueOf&&o.valueOf();if(i!=null&&i!==o)return a.from(i,e,t);var u=J(o);if(u)return u;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return a.from(o[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}a.from=function(o,e,t){return m(o,e,t)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function I(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function g(o,e,t){return I(o),o<=0?d(o):e!==void 0?typeof t=="string"?d(o).fill(e,t):d(o).fill(e):d(o)}a.alloc=function(o,e,t){return g(o,e,t)};function k(o){return I(o),d(o<0?0:O(o)|0)}a.allocUnsafe=function(o){return k(o)},a.allocUnsafeSlow=function(o){return k(o)};function R(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!a.isEncoding(e))throw new TypeError("Unknown encoding: "+e);var t=C(o,e)|0,i=d(t),u=i.write(o,e);return u!==t&&(i=i.slice(0,u)),i}function B(o){for(var e=o.length<0?0:O(o.length)|0,t=d(e),i=0;i<e;i+=1)t[i]=o[i]&255;return t}function V(o){if(oe(o,Uint8Array)){var e=new Uint8Array(o);return P(e.buffer,e.byteOffset,e.byteLength)}return B(o)}function P(o,e,t){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');var i;return e===void 0&&t===void 0?i=new Uint8Array(o):t===void 0?i=new Uint8Array(o,e):i=new Uint8Array(o,e,t),Object.setPrototypeOf(i,a.prototype),i}function J(o){if(a.isBuffer(o)){var e=O(o.length)|0,t=d(e);return t.length===0||o.copy(t,0,0,e),t}if(o.length!==void 0)return typeof o.length!="number"||Ie(o.length)?d(0):B(o);if(o.type==="Buffer"&&Array.isArray(o.data))return B(o.data)}function O(o){if(o>=f)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+f.toString(16)+" bytes");return o|0}function W(o){return+o!=o&&(o=0),a.alloc(+o)}a.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==a.prototype},a.compare=function(e,t){if(oe(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),oe(t,Uint8Array)&&(t=a.from(t,t.offset,t.byteLength)),!a.isBuffer(e)||!a.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var i=e.length,u=t.length,p=0,x=Math.min(i,u);p<x;++p)if(e[p]!==t[p]){i=e[p],u=t[p];break}return i<u?-1:u<i?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return a.alloc(0);var i;if(t===void 0)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var u=a.allocUnsafe(t),p=0;for(i=0;i<e.length;++i){var x=e[i];if(oe(x,Uint8Array))p+x.length>u.length?a.from(x).copy(u,p):Uint8Array.prototype.set.call(u,x,p);else if(a.isBuffer(x))x.copy(u,p);else throw new TypeError('"list" argument must be an Array of Buffers');p+=x.length}return u};function C(o,e){if(a.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||oe(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);var t=o.length,i=arguments.length>2&&arguments[2]===!0;if(!i&&t===0)return 0;for(var u=!1;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return be(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return Fe(o).length;default:if(u)return i?-1:be(o).length;e=(""+e).toLowerCase(),u=!0}}a.byteLength=C;function U(o,e,t){var i=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return j(this,e,t);case"utf8":case"utf-8":return Q(this,e,t);case"ascii":return te(this,e,t);case"latin1":case"binary":return ee(this,e,t);case"base64":return S(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return pe(this,e,t);default:if(i)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),i=!0}}a.prototype._isBuffer=!0;function q(o,e,t){var i=o[e];o[e]=o[t],o[t]=i}a.prototype.swap16=function(){var e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)q(this,t,t+1);return this},a.prototype.swap32=function(){var e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)q(this,t,t+3),q(this,t+1,t+2);return this},a.prototype.swap64=function(){var e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)q(this,t,t+7),q(this,t+1,t+6),q(this,t+2,t+5),q(this,t+3,t+4);return this},a.prototype.toString=function(){var e=this.length;return e===0?"":arguments.length===0?Q(this,0,e):U.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:a.compare(this,e)===0},a.prototype.inspect=function(){var e="",t=n.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},c&&(a.prototype[c]=a.prototype.inspect),a.prototype.compare=function(e,t,i,u,p){if(oe(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),i===void 0&&(i=e?e.length:0),u===void 0&&(u=0),p===void 0&&(p=this.length),t<0||i>e.length||u<0||p>this.length)throw new RangeError("out of range index");if(u>=p&&t>=i)return 0;if(u>=p)return-1;if(t>=i)return 1;if(t>>>=0,i>>>=0,u>>>=0,p>>>=0,this===e)return 0;for(var x=p-u,T=i-t,$=Math.min(x,T),l=this.slice(u,p),w=e.slice(t,i),E=0;E<$;++E)if(l[E]!==w[E]){x=l[E],T=w[E];break}return x<T?-1:T<x?1:0};function v(o,e,t,i,u){if(o.length===0)return-1;if(typeof t=="string"?(i=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,Ie(t)&&(t=u?0:o.length-1),t<0&&(t=o.length+t),t>=o.length){if(u)return-1;t=o.length-1}else if(t<0)if(u)t=0;else return-1;if(typeof e=="string"&&(e=a.from(e,i)),a.isBuffer(e))return e.length===0?-1:F(o,e,t,i,u);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?u?Uint8Array.prototype.indexOf.call(o,e,t):Uint8Array.prototype.lastIndexOf.call(o,e,t):F(o,[e],t,i,u);throw new TypeError("val must be string, number or Buffer")}function F(o,e,t,i,u){var p=1,x=o.length,T=e.length;if(i!==void 0&&(i=String(i).toLowerCase(),i==="ucs2"||i==="ucs-2"||i==="utf16le"||i==="utf-16le")){if(o.length<2||e.length<2)return-1;p=2,x/=2,T/=2,t/=2}function $(M,z){return p===1?M[z]:M.readUInt16BE(z*p)}var l;if(u){var w=-1;for(l=t;l<x;l++)if($(o,l)===$(e,w===-1?0:l-w)){if(w===-1&&(w=l),l-w+1===T)return w*p}else w!==-1&&(l-=l-w),w=-1}else for(t+T>x&&(t=x-T),l=t;l>=0;l--){for(var E=!0,L=0;L<T;L++)if($(o,l+L)!==$(e,L)){E=!1;break}if(E)return l}return-1}a.prototype.includes=function(e,t,i){return this.indexOf(e,t,i)!==-1},a.prototype.indexOf=function(e,t,i){return v(this,e,t,i,!0)},a.prototype.lastIndexOf=function(e,t,i){return v(this,e,t,i,!1)};function D(o,e,t,i){t=Number(t)||0;var u=o.length-t;i?(i=Number(i),i>u&&(i=u)):i=u;var p=e.length;i>p/2&&(i=p/2);for(var x=0;x<i;++x){var T=parseInt(e.substr(x*2,2),16);if(Ie(T))return x;o[t+x]=T}return x}function y(o,e,t,i){return Ee(be(e,o.length-t),o,t,i)}function A(o,e,t,i){return Ee(ze(e),o,t,i)}function _(o,e,t,i){return Ee(Fe(e),o,t,i)}function b(o,e,t,i){return Ee(Qe(e,o.length-t),o,t,i)}a.prototype.write=function(e,t,i,u){if(t===void 0)u="utf8",i=this.length,t=0;else if(i===void 0&&typeof t=="string")u=t,i=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(i)?(i=i>>>0,u===void 0&&(u="utf8")):(u=i,i=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var p=this.length-t;if((i===void 0||i>p)&&(i=p),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");u||(u="utf8");for(var x=!1;;)switch(u){case"hex":return D(this,e,t,i);case"utf8":case"utf-8":return y(this,e,t,i);case"ascii":case"latin1":case"binary":return A(this,e,t,i);case"base64":return _(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return b(this,e,t,i);default:if(x)throw new TypeError("Unknown encoding: "+u);u=(""+u).toLowerCase(),x=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function S(o,e,t){return e===0&&t===o.length?r.fromByteArray(o):r.fromByteArray(o.slice(e,t))}function Q(o,e,t){t=Math.min(o.length,t);for(var i=[],u=e;u<t;){var p=o[u],x=null,T=p>239?4:p>223?3:p>191?2:1;if(u+T<=t){var $,l,w,E;switch(T){case 1:p<128&&(x=p);break;case 2:$=o[u+1],($&192)===128&&(E=(p&31)<<6|$&63,E>127&&(x=E));break;case 3:$=o[u+1],l=o[u+2],($&192)===128&&(l&192)===128&&(E=(p&15)<<12|($&63)<<6|l&63,E>2047&&(E<55296||E>57343)&&(x=E));break;case 4:$=o[u+1],l=o[u+2],w=o[u+3],($&192)===128&&(l&192)===128&&(w&192)===128&&(E=(p&15)<<18|($&63)<<12|(l&63)<<6|w&63,E>65535&&E<1114112&&(x=E))}}x===null?(x=65533,T=1):x>65535&&(x-=65536,i.push(x>>>10&1023|55296),x=56320|x&1023),i.push(x),u+=T}return X(i)}var N=4096;function X(o){var e=o.length;if(e<=N)return String.fromCharCode.apply(String,o);for(var t="",i=0;i<e;)t+=String.fromCharCode.apply(String,o.slice(i,i+=N));return t}function te(o,e,t){var i="";t=Math.min(o.length,t);for(var u=e;u<t;++u)i+=String.fromCharCode(o[u]&127);return i}function ee(o,e,t){var i="";t=Math.min(o.length,t);for(var u=e;u<t;++u)i+=String.fromCharCode(o[u]);return i}function j(o,e,t){var i=o.length;(!e||e<0)&&(e=0),(!t||t<0||t>i)&&(t=i);for(var u="",p=e;p<t;++p)u+=Ye[o[p]];return u}function pe(o,e,t){for(var i=o.slice(e,t),u="",p=0;p<i.length-1;p+=2)u+=String.fromCharCode(i[p]+i[p+1]*256);return u}a.prototype.slice=function(e,t){var i=this.length;e=~~e,t=t===void 0?i:~~t,e<0?(e+=i,e<0&&(e=0)):e>i&&(e=i),t<0?(t+=i,t<0&&(t=0)):t>i&&(t=i),t<e&&(t=e);var u=this.subarray(e,t);return Object.setPrototypeOf(u,a.prototype),u};function G(o,e,t){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>t)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(e,t,i){e=e>>>0,t=t>>>0,i||G(e,t,this.length);for(var u=this[e],p=1,x=0;++x<t&&(p*=256);)u+=this[e+x]*p;return u},a.prototype.readUintBE=a.prototype.readUIntBE=function(e,t,i){e=e>>>0,t=t>>>0,i||G(e,t,this.length);for(var u=this[e+--t],p=1;t>0&&(p*=256);)u+=this[e+--t]*p;return u},a.prototype.readUint8=a.prototype.readUInt8=function(e,t){return e=e>>>0,t||G(e,1,this.length),this[e]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||G(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||G(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||G(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||G(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readIntLE=function(e,t,i){e=e>>>0,t=t>>>0,i||G(e,t,this.length);for(var u=this[e],p=1,x=0;++x<t&&(p*=256);)u+=this[e+x]*p;return p*=128,u>=p&&(u-=Math.pow(2,8*t)),u},a.prototype.readIntBE=function(e,t,i){e=e>>>0,t=t>>>0,i||G(e,t,this.length);for(var u=t,p=1,x=this[e+--u];u>0&&(p*=256);)x+=this[e+--u]*p;return p*=128,x>=p&&(x-=Math.pow(2,8*t)),x},a.prototype.readInt8=function(e,t){return e=e>>>0,t||G(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},a.prototype.readInt16LE=function(e,t){e=e>>>0,t||G(e,2,this.length);var i=this[e]|this[e+1]<<8;return i&32768?i|4294901760:i},a.prototype.readInt16BE=function(e,t){e=e>>>0,t||G(e,2,this.length);var i=this[e+1]|this[e]<<8;return i&32768?i|4294901760:i},a.prototype.readInt32LE=function(e,t){return e=e>>>0,t||G(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,t){return e=e>>>0,t||G(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readFloatLE=function(e,t){return e=e>>>0,t||G(e,4,this.length),s.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,t){return e=e>>>0,t||G(e,4,this.length),s.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||G(e,8,this.length),s.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||G(e,8,this.length),s.read(this,e,!1,52,8)};function H(o,e,t,i,u,p){if(!a.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>u||e<p)throw new RangeError('"value" argument is out of bounds');if(t+i>o.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(e,t,i,u){if(e=+e,t=t>>>0,i=i>>>0,!u){var p=Math.pow(2,8*i)-1;H(this,e,t,i,p,0)}var x=1,T=0;for(this[t]=e&255;++T<i&&(x*=256);)this[t+T]=e/x&255;return t+i},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(e,t,i,u){if(e=+e,t=t>>>0,i=i>>>0,!u){var p=Math.pow(2,8*i)-1;H(this,e,t,i,p,0)}var x=i-1,T=1;for(this[t+x]=e&255;--x>=0&&(T*=256);)this[t+x]=e/T&255;return t+i},a.prototype.writeUint8=a.prototype.writeUInt8=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,1,255,0),this[t]=e&255,t+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4},a.prototype.writeIntLE=function(e,t,i,u){if(e=+e,t=t>>>0,!u){var p=Math.pow(2,8*i-1);H(this,e,t,i,p-1,-p)}var x=0,T=1,$=0;for(this[t]=e&255;++x<i&&(T*=256);)e<0&&$===0&&this[t+x-1]!==0&&($=1),this[t+x]=(e/T>>0)-$&255;return t+i},a.prototype.writeIntBE=function(e,t,i,u){if(e=+e,t=t>>>0,!u){var p=Math.pow(2,8*i-1);H(this,e,t,i,p-1,-p)}var x=i-1,T=1,$=0;for(this[t+x]=e&255;--x>=0&&(T*=256);)e<0&&$===0&&this[t+x+1]!==0&&($=1),this[t+x]=(e/T>>0)-$&255;return t+i},a.prototype.writeInt8=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1},a.prototype.writeInt16LE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2},a.prototype.writeInt16BE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2},a.prototype.writeInt32LE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},a.prototype.writeInt32BE=function(e,t,i){return e=+e,t=t>>>0,i||H(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function De(o,e,t,i,u,p){if(t+i>o.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function Be(o,e,t,i,u){return e=+e,t=t>>>0,u||De(o,e,t,4),s.write(o,e,t,i,23,4),t+4}a.prototype.writeFloatLE=function(e,t,i){return Be(this,e,t,!0,i)},a.prototype.writeFloatBE=function(e,t,i){return Be(this,e,t,!1,i)};function Ue(o,e,t,i,u){return e=+e,t=t>>>0,u||De(o,e,t,8),s.write(o,e,t,i,52,8),t+8}a.prototype.writeDoubleLE=function(e,t,i){return Ue(this,e,t,!0,i)},a.prototype.writeDoubleBE=function(e,t,i){return Ue(this,e,t,!1,i)},a.prototype.copy=function(e,t,i,u){if(!a.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),!u&&u!==0&&(u=this.length),t>=e.length&&(t=e.length),t||(t=0),u>0&&u<i&&(u=i),u===i||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(u<0)throw new RangeError("sourceEnd out of bounds");u>this.length&&(u=this.length),e.length-t<u-i&&(u=e.length-t+i);var p=u-i;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,i,u):Uint8Array.prototype.set.call(e,this.subarray(i,u),t),p},a.prototype.fill=function(e,t,i,u){if(typeof e=="string"){if(typeof t=="string"?(u=t,t=0,i=this.length):typeof i=="string"&&(u=i,i=this.length),u!==void 0&&typeof u!="string")throw new TypeError("encoding must be a string");if(typeof u=="string"&&!a.isEncoding(u))throw new TypeError("Unknown encoding: "+u);if(e.length===1){var p=e.charCodeAt(0);(u==="utf8"&&p<128||u==="latin1")&&(e=p)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;t=t>>>0,i=i===void 0?this.length:i>>>0,e||(e=0);var x;if(typeof e=="number")for(x=t;x<i;++x)this[x]=e;else{var T=a.isBuffer(e)?e:a.from(e,u),$=T.length;if($===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(x=0;x<i-t;++x)this[x+t]=T[x%$]}return this};var $e=/[^+/0-9A-Za-z-_]/g;function Le(o){if(o=o.split("=")[0],o=o.trim().replace($e,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function be(o,e){e=e||1/0;for(var t,i=o.length,u=null,p=[],x=0;x<i;++x){if(t=o.charCodeAt(x),t>55295&&t<57344){if(!u){if(t>56319){(e-=3)>-1&&p.push(239,191,189);continue}else if(x+1===i){(e-=3)>-1&&p.push(239,191,189);continue}u=t;continue}if(t<56320){(e-=3)>-1&&p.push(239,191,189),u=t;continue}t=(u-55296<<10|t-56320)+65536}else u&&(e-=3)>-1&&p.push(239,191,189);if(u=null,t<128){if((e-=1)<0)break;p.push(t)}else if(t<2048){if((e-=2)<0)break;p.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;p.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;p.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return p}function ze(o){for(var e=[],t=0;t<o.length;++t)e.push(o.charCodeAt(t)&255);return e}function Qe(o,e){for(var t,i,u,p=[],x=0;x<o.length&&!((e-=2)<0);++x)t=o.charCodeAt(x),i=t>>8,u=t%256,p.push(u),p.push(i);return p}function Fe(o){return r.toByteArray(Le(o))}function Ee(o,e,t,i){for(var u=0;u<i&&!(u+t>=e.length||u>=o.length);++u)e[u+t]=o[u];return u}function oe(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Ie(o){return o!==o}var Ye=function(){for(var o="0123456789abcdef",e=new Array(256),t=0;t<16;++t)for(var i=t*16,u=0;u<16;++u)e[i+u]=o[t]+o[u];return e}()})(xt);const ht=new Map;function Ze(n){n=String(n);const r=ht.get(n);if(r)return r;const s=ar(n);return ht.set(n,s),s}function ar(n){const r=sr(n);me(()=>r.doc.queries.map(y=>y.name),()=>r.doc.queries.forEach(y=>ae(y.name)),{deep:!0});function s(y,A){Se.replace(`/workbook/${r.name}/${y}/${A}`)}function c(y,A){const _=Se.currentRoute.value.path;return new RegExp(`/workbook/${r.name}/${y}/${A}`).test(_)}async function f(){const y=dr();y.doc.title="Query "+(r.doc.queries.length+1),y.doc.workbook=r.doc.name,y.doc.use_live_connection=!0,y.doc.sort_order=r.doc.queries.length,y.doc.folder=null,y.insert().then(()=>{r.doc.queries.push({name:y.doc.name,title:y.doc.title,sort_order:y.doc.sort_order,folder:null}),s("query",y.doc.name)})}function h(y){function A(){const _=r.doc.queries.findIndex(S=>S.name===y);if(_===-1)return;const b=ae(y);he(()=>b.isloaded).then(()=>b.delete()),g("query",_),r.doc.queries.splice(_,1)}de({title:"Delete Query",message:"Are you sure you want to delete this query?",onSuccess:A})}function d(y){const A=Cr();A.doc.title="Chart "+(r.doc.charts.length+1),A.doc.workbook=r.doc.name,A.doc.query=y||"",A.doc.chart_type="Bar",A.doc.sort_order=r.doc.charts.length,A.doc.folder=null,A.insert().then(()=>{r.doc.charts.push({name:A.doc.name,title:A.doc.title,query:A.doc.query,chart_type:"Bar",sort_order:A.doc.sort_order,folder:null}),s("chart",A.doc.name)})}function a(y){function A(){const _=r.doc.charts.findIndex(S=>S.name===y);if(_===-1)return;const b=St(y);he(()=>b.isloaded).then(()=>b.delete()),g("chart",_),r.doc.charts.splice(_,1)}de({title:"Delete Chart",message:"Are you sure you want to delete this chart?",onSuccess:A})}function m(){const y=Rr();y.doc.title="Dashboard "+(r.doc.dashboards.length+1),y.doc.workbook=r.doc.name,y.insert().then(()=>{r.doc.dashboards.push({name:y.doc.name,title:y.doc.title}),s("dashboard",y.doc.name)})}function I(y){function A(){const _=r.doc.dashboards.findIndex(S=>S.name===y);if(_===-1)return;const b=Br(y);he(()=>b.isloaded).then(()=>b.delete()),g("dashboard",_),r.doc.dashboards.splice(_,1)}de({title:"Delete Dashboard",message:"Are you sure you want to delete this dashboard?",onSuccess:A})}function g(y,A){const _={query:r.doc.queries,chart:r.doc.charts,dashboard:r.doc.dashboards}[y];let b=A+1;if(b>=_.length&&(b=0),b<0&&(b=_.length-1),b>=0&&b<_.length){s(y,_[b].name);return}Se.replace(`/workbook/${r.name}`)}const k=ue(()=>{var y;return r.doc.owner===((y=Ge.user)==null?void 0:y.email)}),R=ue(()=>k.value);async function B(){return _e("insights.api.workbooks.get_share_permissions",{workbook_name:r.name}).then(A=>({user_permissions:A.user_permissions.map(_=>({email:_.user,full_name:_.full_name,access:_.read?_.write?"edit":"view":void 0})),organization_access:A.organization_access}))}async function V(y){return _e("insights.api.workbooks.update_share_permissions",{workbook_name:r.name,organization_access:y.organization_access,user_permissions:y.user_permissions.map(_=>({user:_.email,read:_.access==="view",write:_.access==="edit"}))}).catch(we)}function P(){de({title:"Duplicate Workbook",message:"Duplicating this workbook will create a new workbook and copy all queries, charts and dashboards to it. Do you want to continue?",onSuccess:()=>{r.call("duplicate").then(y=>{se({message:"Workbook duplicated successfully",variant:"success"}),Se.push(`/workbook/${y}`)}).catch(we)}})}function J(y){de({title:"Import Query",message:"Are you sure you want to import this query?",onSuccess:()=>{r.call("import_query",{query:y}).then(A=>{r.load().then(()=>{se({message:"Query imported successfully",variant:"success"}),s("query",A)})})}})}function O(y){de({title:"Import Chart",message:"Are you sure you want to import this chart?",onSuccess:()=>{r.call("import_chart",{chart:y}).then(A=>{r.load().then(()=>{se({message:"Chart imported successfully",variant:"success"}),s("chart",A)})})}})}function W(){r.call("export").then(y=>{He(JSON.stringify(y,null,2))})}function C(){de({title:"Delete Workbook",message:"Are you sure you want to delete this workbook?",theme:"red",onSuccess:()=>{r.delete().then(()=>{Se.replace("/workbook")})}})}async function U(y="New Folder",A){return _e("insights.api.workbooks.create_folder",{workbook:r.name,title:y,folder_type:A}).then(b=>(r.load().then(()=>{se({message:"Folder created",variant:"success"})}),b)).catch(we)}function q(y){function A(){_e("insights.api.workbooks.delete_folder",{folder_name:y,move_items_to_root:!0}).then(()=>{r.load(),se({message:"Folder deleted",variant:"success"})}).catch(we)}de({title:"Delete Folder",message:"This will move all items in the folder to the root. Continue?",onSuccess:A})}async function v(y,A){return _e("insights.api.workbooks.rename_folder",{folder_name:y,new_title:A}).then(()=>{r.load()}).catch(we)}async function F(y,A,_){return _e("insights.api.workbooks.move_item_to_folder",{item_type:y,item_name:A,folder_name:_||null}).then(()=>r.load()).catch(we)}async function D(y){return _e("insights.api.workbooks.update_sort_orders",{workbook:r.name,items:y}).catch(we)}return Me({...Oe(r),canShare:R,isOwner:k,showSidebar:!0,isActiveTab:c,duplicate:P,importQuery:J,importChart:O,addQuery:f,removeQuery:h,addChart:d,removeChart:a,addDashboard:m,removeDashboard:I,addFolder:U,removeFolder:q,renameFolder:v,moveItemToFolder:F,updateSortOrder:D,getSharePermissions:B,updateSharePermissions:V,getLinkedQueries:Ke,copy:W,openInDesk(){window.open(`/app/insights-workbook/${r.name}`,"_blank")},delete:C})}const Or=Symbol();function sr(n){const r="Insights Workbook",s=Te(r,n,{initialDoc:{doctype:r,name:n,owner:"",title:"",folders:[],queries:[],charts:[],dashboards:[],read_only:!1},enableAutoSave:!0,disableLocalStorage:!0,transform(c){return c.folders=ve(c.folders)||[],c.queries=ve(c.queries)||[],c.charts=ve(c.charts)||[],c.dashboards=ve(c.dashboards)||[],c}});return s.onAfterLoad(()=>s.call("track_view").catch(()=>{})),me(()=>s.doc.read_only,()=>{s.doc.read_only&&(s.autoSave=!1)}),s}function Tr(){return`new-workbook-${ce()}`}function Ke(n){const r=ae(n),s=new Set;r.isloaded||console.log("Operations not loaded yet for query",n);const c=Je(r.currentOperations);return r.activeEditIndex>-1&&c.splice(r.activeEditIndex),c.forEach(f=>{"table"in f&&"type"in f.table&&f.table.type==="query"&&s.add(f.table.query_name)}),s.forEach(f=>Ke(f).forEach(h=>s.add(h))),Array.from(s)}const mt=new Map;function ae(n){const r=String(n),s=mt.get(r);if(s)return s;const c=ur(n);return mt.set(r,c),c}function ur(n){const r=bt(n),s=ne(-1);r.onAfterLoad(()=>{s.value=r.doc.operations.length-1});const c=ue(()=>s.value>=0?r.doc.operations.slice(0,s.value+1):r.doc.operations.slice()),f=ue(()=>h(c.value));function h(l){const w=l.find(E=>E.type==="source");if(!w)return"";if(w.table.type==="table")return w.table.data_source;if(w.table.type==="query"&&"query_name"in w.table){const E=ae(w.table.query_name);return h(E.currentOperations)}return""}const d=ne(-1),a=ue(()=>d.value===-1?{}:r.doc.operations[d.value]),m=ne({...We}),I=ne(!1),g=ne(!1),k=ne(null);let R;const B=ne();async function V(l=!1){if(r.islocal||await he(()=>r.isloaded),!r.doc.operations.length){m.value={...We};return}return!l&&R&&Nt(R,{operations:c.value,adhoc_filters:B.value})?Promise.resolve():(I.value=!0,r.call("execute",{active_operation_idx:s.value,adhoc_filters:B.value,force:l}).then(w=>{w&&(m.value.executedSQL=w.sql,m.value.columns=w.columns,m.value.rows=w.rows,m.value.totalRowCount=0,m.value.formattedRows=$t(m.value,r.doc.operations),m.value.columnOptions=m.value.columns.map(E=>({label:E.name,value:E.name,description:E.type,query:r.doc.name,data_type:E.type})),m.value.timeTaken=w.time_taken,m.value.lastExecutedAt=new Date)}).catch(()=>{m.value={...We}}).finally(()=>{I.value=!1,R={operations:c.value,adhoc_filters:B.value}}))}const P=ne(!1);async function J(){if(r.islocal||await he(()=>r.isloaded),!r.doc.operations.length){m.value.totalRowCount=0;return}return P.value=!0,r.call("get_count",{active_operation_idx:s.value,adhoc_filters:B.value}).then(l=>{m.value.totalRowCount=l||0}).finally(()=>{P.value=!1})}async function O(l){if(!l.raw_sql.trim())return l.raw_sql||"";try{const w=await r.call("format",{raw_sql:l.raw_sql.trim()}),E=Fe();return E?E.raw_sql=w:console.warn("No SQL operation found for native query."),w}catch(w){return console.error("Error formatting SQL:",w),l.raw_sql}}function W(l){s.value=l,d.value=-1}function C(l){d.value=l}function U(l){r.doc.operations.splice(l,1),!(l>s.value)&&(s.value--,s.value=Math.max(s.value,-1))}function q(l){const w=a.value.type==="source",E=()=>{var L;if(w?(r.doc.operations[d.value]=dt(l),C(-1)):(r.doc.operations=[dt(l)],s.value=0),(L=r.doc.title)!=null&&L.match(/Query \d+/)&&"table_name"in l.table&&(r.doc.title=l.table.table_name),l.table.type=="query"){const M=ae(l.table.query_name);r.doc.use_live_connection=Ut(M.doc.use_live_connection)}};if(!r.doc.operations.length||w){E();return}de({title:"Change Source",message:"Changing the source will clear the current operations. Please confirm.",onSuccess:E})}function v(l){r.doc.operations.splice(s.value+1,0,l),s.value++}function F(l){a.value.type==="join"?(r.doc.operations[d.value]=rt(l),C(-1)):v(rt(l))}function D(l){a.value.type==="union"?(r.doc.operations[d.value]=nt(l),C(-1)):v(nt(l))}function y(l){a.value.type==="filter_group"||a.value.type==="filter"?(r.doc.operations[d.value]=je(l),C(-1)):v(je(l))}function A(l){a.value.type==="mutate"?(r.doc.operations[d.value]=ot(l),C(-1)):v(ot(l))}function _(l){a.value.type==="summarize"?(r.doc.operations[d.value]=it(l),C(-1)):v(it(l))}function b(l){if(c.value.find(L=>L.type==="order_by"&&L.column.column_name===l.column.column_name&&L.direction===l.direction))return;const E=c.value.findIndex(L=>L.type==="order_by"&&L.column.column_name===l.column.column_name);E>-1?r.doc.operations[E]=at(l):v(at(l))}function S(l){const w=r.doc.operations.findIndex(E=>E.type==="order_by"&&E.column.column_name===l);w>-1&&r.doc.operations.splice(w,1)}function Q(l){v(Wt(l))}function N(l){v(zt(l))}function X(l){a.value.type==="select"?(r.doc.operations[d.value]=st(l),C(-1)):v(st(l))}function te(l,w){const E=c.value.findIndex(Y=>Y.type==="mutate"&&Y.new_name===l);if(E!==-1){const Y=r.doc.operations[E];r.doc.operations[E]={...Y,new_name:w};return}const L=c.value.findIndex(Y=>Y.type==="rename"&&Y.new_name===l);if(L===-1){v(ut({column:fe(l),new_name:w}));return}const z=c.value[L].column.column_name;if(z===w){U(L);return}r.doc.operations.splice(L,1),v(ut({column:fe(z),new_name:w}))}function ee(l){Array.isArray(l)||(l=[l]);const w=r.doc.operations[s.value];(w==null?void 0:w.type)==="remove"?r.doc.operations[s.value]=lt({column_names:[...w.column_names,...l]}):v(lt({column_names:l}))}function j(l,w){const E=c.value.findIndex(L=>L.type==="mutate"&&L.new_name===l);if(E!==-1){const L=r.doc.operations[E];r.doc.operations[E]={...L,data_type:w};return}v(Qt({column:fe(l),data_type:w}))}function pe(l){a.value.type==="custom_operation"?(r.doc.operations[d.value]=ct(l),C(-1)):v(ct(l))}function G(l){r.doc.operations=l,s.value=l.length-1}function H(l="csv",w){(()=>{g.value=!0;const L=Date.now()+Math.random();return k.value=L,_e("insights.api.run_doc_method",{method:"download_results",docs:{...r.doc||{},__islocal:r.islocal},args:{format:l,active_operation_idx:s.value,adhoc_filters:B.value}}).then(M=>{if(k.value!==L)return;const z=M==null?void 0:M.message;if(!z){se({title:"Download Failed",message:"No data found to download.",variant:"warning"});return}let Y,re;if(l==="excel"){const Re=xt.Buffer.from(z,"base64");Y=new Blob([Re],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),re="xlsx"}else Y=new Blob([z],{type:"text/csv"}),re="csv";const ke=window.URL.createObjectURL(Y),K=document.createElement("a");K.setAttribute("hidden",""),K.setAttribute("href",ke);const ye=`${w||r.doc.title||"data"}.${re}`;K.setAttribute("download",ye),document.body.appendChild(K),K.click(),document.body.removeChild(K),window.URL.revokeObjectURL(ke),se({title:"Export Successful",message:`File "${ye}" exported successfully`,variant:"success"})}).catch(M=>{k.value===L&&se({title:"Download Failed",message:(M==null?void 0:M.message)||"Failed to download file",variant:"error"})}).finally(()=>{k.value===L&&(g.value=!1,k.value=null)})})()}function De(){k.value=null,g.value=!1}function Be(l,w){H(l,w)}function Ue(l,w="",E=20){let L=s.value;return d.value>-1&&(L=d.value-1),r.call("get_distinct_column_values",{active_operation_idx:L,adhoc_filters:B.value,column_name:l,search_term:w,limit:E})}function $e(){let l=s.value;return d.value>-1&&(l=d.value-1),r.call("get_columns_for_selection",{active_operation_idx:l}).then(w=>w.map(E=>({label:E.name,value:E.name,description:E.type,query:r.doc.name,data_type:E.type})))}const Le=ue(()=>Mt(m.value.columns)),be=ue(()=>Ot(m.value.columns));function ze(l){return Le.value.find(w=>w.column_name===l)}function Qe(l){return be.value.find(w=>w.measure_name===l)}function Fe(){return r.doc.is_native_query?r.doc.operations.find(l=>l.type==="sql"):""}function Ee(l,w=!1){r.doc.operations=[],l.raw_sql.trim().length?(r.doc.operations.push(Yt(l)),s.value=0,V(w)):s.value=-1}function oe(){return r.doc.operations.find(l=>l.type==="code")}function Ie(l){r.doc.operations=[],l.code.trim().length?(r.doc.operations.push(Vt(l)),s.value=0):s.value=-1}function Ye(l){return r.doc.is_script_query?(r.doc.variables=l,r.save().then(()=>{se({title:"Variables Updated",message:"Script variables have been saved securely.",variant:"success"})}).catch(w=>{throw se({title:"Failed to Update Variables",message:w.message||"An error occurred while saving variables.",variant:"error"}),w})):Promise.resolve()}function o(l,w){if(!Ge.isLoggedIn)return;const E=p(l,w);if(E){se({title:"Failed to drill down",message:E,variant:"warning"});return}const L=Je(r.doc.operations),M=L.slice().reverse(),z=ae("new-query-"+ce());z.doc.title="Drill Down",z.doc.use_live_connection=r.doc.use_live_connection,z.autoExecute=!0;let Y=[],re=-1;const ke=m.value.formattedRows.findIndex(Ce=>Ce===w),K=m.value.rows[ke],ye=M.findIndex(Ce=>Ce.type==="pivot_wider");ye!==-1&&(re=M.length-ye-1,Y=u(L,re,l,K));const Re=M.findIndex(Ce=>Ce.type==="summarize");return Re!==-1&&(re=M.length-Re-1,Y=i(L,re,l,K)),z.setOperations(L.slice(0,re)),z.addFilterGroup({logical_operator:"And",filters:Y}),z}function e(l,w){const E=[];if(Z.DATE.includes(l.data_type)||E.push({column:fe(l.column_name),operator:"=",value:w}),Z.DATE.includes(l.data_type)){const L=Lt(w);if(E.push({column:fe(l.column_name),operator:">=",value:L.format("YYYY-MM-DD HH:mm:ss")}),l.granularity){const M=L.clone().add(1,l.granularity);E.push({column:fe(l.column_name),operator:"<",value:M.format("YYYY-MM-DD HH:mm:ss")})}}return E}function t(l,w){if(l.measure_name!==w||!("expression"in l)||!l.expression)return[];const E=l.expression.expression,M=[/^count_if\(([^,]+),\s*([^)]+)\)$/,/^count_if\(([^,]+)\)$/,/^sum_if\(([^,]+),\s*([^)]+)\)$/,/^distinct_count_if\(([^,]+),\s*([^)]+)\)$/].find(z=>E.match(z));if(M){const z=E.match(M);if(z){const Y=z[1].trim();return[{expression:jt(Y)}]}}return[]}function i(l,w,E,L){const M=[],z=l[w];return z.dimensions.forEach(Y=>{M.push(...e(Y,L[Y.dimension_name]))}),z.measures.forEach(Y=>{M.push(...t(Y,E.name))}),M}function u(l,w,E,L){const M=ae("new-query-"+ce());M.doc.title="Drill Down",M.autoExecute=!0,M.doc.workbook=r.doc.workbook,M.doc.use_live_connection=r.doc.use_live_connection,M.setOperations(l.slice(0,w));const z=l[w],Y=[];z.rows.forEach(K=>{Y.push(...e(K,L[K.dimension_name]))});const re=E.name.split("___").reverse();z.columns.forEach((K,ye)=>{re[ye]&&Y.push(...e(K,re[ye]))});const ke=z.values.length==1?z.values[0].measure_name:re.at(-1);return z.values.forEach(K=>Y.push(...t(K,ke))),Y}function p(l,w){var E,L;if(!r.doc.operations.find(M=>M.type==="summarize"||M.type==="pivot_wider"))return"Drill down is only supported on summarized data";if(!((E=m.value.columns)!=null&&E.length))return"No columns found in the result";if(!w)return"Row not found";if(!((L=m.value.rows)!=null&&L.length))return"No rows found in the result";if(!m.value.formattedRows.find(M=>M===w))return"Row not found in the result"}function x(){r.call("export").then(l=>{He(JSON.stringify(l,null,2))})}const T=vt(ue({get(){return{doc:r.doc,activeOperationIdx:s.value,activeEditIndex:d.value}},set(l){Object.assign(r.doc,l.doc),s.value=l.activeOperationIdx,d.value=l.activeEditIndex}}),{deep:!0,capacity:100,debounce:500}),$=ne(!1);return Tt(c,()=>$.value&&V(),{immediate:!0,deep:!0,toggleCondition:()=>$.value}),he(()=>r.isloaded).then(()=>{me(()=>r.doc.title,()=>{if(!r.doc.workbook)return;const l=Ze(r.doc.workbook);for(const w of l.doc.queries)if(w.name===r.doc.name){w.title=r.doc.title;break}},{debounce:500})}),Me({...Oe(r),activeOperationIdx:s,activeEditIndex:d,dataSource:f,currentOperations:c,activeEditOperation:a,adhocFilters:B,autoExecute:$,executing:I,fetchingCount:P,result:m,execute:V,fetchResultCount:J,setOperations:G,setActiveOperation:W,setActiveEditIndex:C,removeOperation:U,setSource:q,addJoin:F,addUnion:D,addFilterGroup:y,addMutate:A,addSummarize:_,addOrderBy:b,removeOrderBy:S,addLimit:Q,addPivotWider:N,selectColumns:X,renameColumn:te,removeColumn:ee,changeColumnType:j,addCustomOperation:pe,getDistinctColumnValues:Ue,getColumnsForSelection:$e,downloadResults:H,exportResults:Be,downloading:g,cancelDownload:De,getSQLOperation:Fe,setSQL:Ee,formatSQL:O,getCodeOperation:oe,setCode:Ie,updateVariables:Ye,dimensions:Le,measures:be,getDimension:ze,getMeasure:Qe,getDrillDownQuery:o,copy:x,history:T,canUndo(){return!d.value&&!I.value},canRedo(){return!d.value&&!I.value}})}const We={executedSQL:"",totalRowCount:0,rows:[],formattedRows:[],columns:[],columnOptions:[],timeTaken:0,lastExecutedAt:new Date},lr={doctype:"Insights Query v3",name:"",owner:"",title:"",workbook:"",operations:[],read_only:!1};function bt(n){const s=Te("Insights Query v3",n,{initialDoc:{...lr,name:n},enableAutoSave:!0,disableLocalStorage:!0,transform:cr});return me(()=>s.doc.read_only,()=>{s.doc.read_only&&(s.autoSave=!1)}),s}function cr(n){return n.operations=ve(n.operations)||[],n.is_native_query===void 0&&n.is_script_query===void 0&&n.is_builder_query===void 0&&(n.is_builder_query=!0),n}function dr(){return bt("new-query-"+ce())}const xe=["Bar","Line","Row"],fr=["Number",...xe,"Donut","Funnel","Table","Map"],hr={blue:"#318AD8",pink:"#F683AE",green:"#48BB74",red:"#F56B6B",yellow:"#FACF7A",purple:"#44427B",teal:"#5FD8C4",orange:"#F8814F",cyan:"#15CCEF",grey:"#A6B1B9","#449CF0":"#449CF0","#ECAD4B":"#ECAD4B","#761ACB":"#761ACB","#CB2929":"#CB2929","#ED6396":"#ED6396","#29CD42":"#29CD42","#4463F0":"#4463F0","#EC864B":"#EC864B","#4F9DD9":"#4F9DD9","#39E4A5":"#39E4A5","#B4CD29":"#B4CD29"},mr={blue:["#2d87d6","#4393da","#589fdf","#6dace3","#83b8e7","#98c4eb","#c3dcf3","#d8e9f7","#edf5fc","#ffffff"]},et=()=>Object.values(hr),pr=n=>mr[n];function Nr(n,r){const s=r.columns,c=r.rows,f=s.filter(O=>Z.NUMBER.includes(O.type)),h=f.length>1,d=n.y_axis.show_scrollbar||!1,a=At(n.x_axis),m=Z.DATE.includes(n.x_axis.dimension.data_type),I=m?Ct(n.x_axis.dimension.dimension_name,n):null,g=qe({min:n.y_axis.min,max:n.y_axis.max}),k=qe(),B=n.y_axis.series.some(O=>O.align==="Right")?[g,k]:[g],V=m?c.sort((O,W)=>{const C=new Date(O[n.x_axis.dimension.dimension_name]),U=new Date(W[n.x_axis.dimension.dimension_name]);return C.getTime()-U.getTime()}):c,P=O=>V.map(W=>{const C=W[n.x_axis.dimension.dimension_name],U=W[O];return[C,U]}),J=et();return{animation:!0,animationDuration:700,dataZoom:Et(d),grid:Ft({show_legend:h,show_scrollbar:d}),color:J,xAxis:a,yAxis:B,series:f.map((O,W)=>{var S,Q,N,X;const C=kt(n,O.name),U=C.align==="Right",q=((S=C.type)==null?void 0:S.toLowerCase())||"line",v=C.smooth??n.y_axis.smooth,F=C.show_data_points??n.y_axis.show_data_points,D=C.show_area??n.y_axis.show_area,y=C.show_data_labels??n.y_axis.show_data_labels,A=((Q=C.color)==null?void 0:Q[0])||J[W],_=(X=(N=n.split_by)==null?void 0:N.dimension)!=null&&X.column_name?O.name:C.measure.measure_name||O.name;let b="top";return q==="bar"&&(b="inside"),{type:q,name:_,data:P(O.name),color:A,yAxisIndex:U?1:0,smooth:v?.4:!1,smoothMonotone:"x",showSymbol:F||y,label:{fontSize:11,show:y,position:b,formatter:te=>{var ee;return ge((ee=te.value)==null?void 0:ee[1],1)}},labelLayout:{hideOverlap:!0},itemStyle:{color:A},areaStyle:D?yr(A):void 0}}),tooltip:It({xAxisIsDate:m,granularity:I}),legend:tt(h,d)}}function yr(n){return{color:new Rt(0,0,0,1,[{offset:0,color:n},{offset:1,color:"#fff"}]),opacity:.2}}function Et(n,r=!1){return{show:n,orient:r?"vertical":"horizontal",type:"slider",zoomLock:!1,bottom:r?"20%":"4%",height:r?"80%":15,width:r?15:"90%",left:r?null:"5%",right:r?10:null,handleSize:25}}function $r(n,r,s=!1){const c=r.columns,f=r.rows,h=c.filter(C=>Z.NUMBER.includes(C.type)),d=h.length>1,a=n.y_axis.show_scrollbar||!1,m=At(n.x_axis),I=Z.DATE.includes(n.x_axis.dimension.data_type),g=I?Ct(n.x_axis.dimension.dimension_name,n):null,k=qe({normalized:n.y_axis.normalize,min:n.y_axis.min,max:n.y_axis.max}),R=qe({normalized:n.y_axis.normalize}),V=n.y_axis.series.some(C=>C.align==="Right")?[k,R]:[k],P=I?f.sort((C,U)=>{const q=new Date(C[n.x_axis.dimension.dimension_name]),v=new Date(U[n.x_axis.dimension.dimension_name]);return q.getTime()-v.getTime()}):f,J=f.reduce((C,U)=>{const q=U[n.x_axis.dimension.dimension_name];return C[q]||(C[q]=0),h.forEach(v=>C[q]+=U[v.name]),C},{}),O=C=>P.map(U=>{const q=U[n.x_axis.dimension.dimension_name],v=U[C];if(!n.y_axis.normalize)return[q,v];const D=J[q],y=D?v/D*100:0;return[q,y]}).map(U=>s?[U[1],U[0]]:U),W=et();return{animation:!0,animationDuration:700,color:W,grid:Ft({show_legend:d,show_scrollbar:a,swapAxes:s}),xAxis:s?V:m,yAxis:s?m:V,dataZoom:Et(a,s),series:h.map((C,U)=>{var N,X,te,ee;const q=kt(n,C.name),v=q.align==="Right",F=((N=q.color)==null?void 0:N[0])||W[U],D=((X=q.type)==null?void 0:X.toLowerCase())||"bar",y=D==="bar"&&n.y_axis.stack?"stack":void 0,A=q.show_data_labels??n.y_axis.show_data_labels,_=O(C.name),b=(ee=(te=n.split_by)==null?void 0:te.dimension)!=null&&ee.column_name?C.name:q.measure.measure_name||C.name,S=s?[0,2,2,0]:[2,2,0,0];h.length-1;let Q="inside";return D=="line"&&(Q="top"),{type:D,stack:n.y_axis.overlap?void 0:y,name:b,data:s?_.reverse():_,color:F,label:{show:A,position:Q,formatter:j=>{var G,H;const pe=s?(G=j.value)==null?void 0:G[0]:(H=j.value)==null?void 0:H[1];return ge(pe,1)},fontSize:11},barGap:n.y_axis.overlap?"-100%":void 0,labelLayout:{hideOverlap:!0},yAxisIndex:v?1:0,itemStyle:{color:F,borderRadius:S}}}),tooltip:It({xAxisIsDate:I,granularity:g,xySwapped:s}),legend:tt(d,a,s)}}function kt(n,r){var c,f;let s;return(f=(c=n.split_by)==null?void 0:c.dimension)!=null&&f.column_name?n.y_axis.series.filter(d=>d.measure.measure_name).length===1?s=n.y_axis.series[0]:s=n.y_axis.series.find(d=>r.includes(d.measure.measure_name)):s=n.y_axis.series.find(h=>h.measure.measure_name===r),s||{measure:{measure_name:r}}}function At(n){const r=n.dimension.data_type,s=r&&Z.DATE.includes(r),c=Math.min(Math.max(n.label_rotation||0,0),90);return{type:s?"time":"category",z:2,scale:!0,alignTicks:!0,boundaryGap:["1%","1%"],splitLine:{show:!1},axisLine:{show:!0,onZero:!0},axisTick:{show:!0},axisLabel:{show:!0,rotate:c,width:100,overflow:"truncate",ellipsis:"..."}}}function qe(n={}){return{show:!0,type:"value",z:2,scale:!1,alignTicks:!0,boundaryGap:["0%","1%"],splitLine:{show:!0},axisTick:{show:!0},axisLine:{show:!0,onZero:!0},axisLabel:{show:!0,hideOverlap:!0,margin:8,formatter:r=>ge(r,1)},min:n.normalized?0:n.min||void 0,max:n.normalized?100:n.max||void 0}}function zr(n,r){const s=r.columns,c=r.rows,f=s.find(U=>Z.MEASURE.includes(U.type)),h=_r(s,c,n.max_slices||10),d=h.map(U=>U[0]),a=h.map(U=>U[1]),m=a.reduce((U,q)=>U+q,0),I=et();let g,k,R,B,V,P,J,O;const W=n.legend_position||"bottom",C=n.show_inline_labels||!1;return W=="bottom"&&(O="horizontal",k=["45%","75%"],g=["50%","45%"],P=0,B="center",J=[30,30,10,30]),W=="top"&&(O="horizontal",k=["45%","75%"],g=["50%","55%"],R=0,B="center",J=20),W=="right"&&(O="vertical",k=["45%","80%"],g=["33%","50%"],B="63%",R="middle",J=[30,0,30,0]),W=="left"&&(O="vertical",k=["45%","80%"],g=["67%","50%"],V="63%",R="middle",J=[30,0,30,0]),C&&(g=["50%","50%"],k=["45%","75%"]),{animation:!0,animationDuration:700,color:I,dataset:{source:h},series:[{type:"pie",name:f==null?void 0:f.name,center:g,radius:k,labelLine:{show:C,lineStyle:{width:2},length:10,length2:20,smooth:!0},label:{show:C,formatter:({value:U,name:q})=>{const v=m>0?U[1]/m*100:0;return`${ft(q,20)} (${v.toFixed(0)}%)`}},emphasis:{scaleSize:5}}],legend:C?{show:!1}:{...tt(),top:R,left:B,right:V,bottom:P,padding:J,orient:O,formatter:U=>{const q=d.indexOf(U),v=m>0?a[q]/m*100:0;return`${ft(U,20)} (${v.toFixed(0)}%)`}},tooltip:{trigger:"item",confine:!0,appendToBody:!1,valueFormatter:U=>{const q=U/m*100;return`${Pe(U,2)} (${q.toFixed(0)}%)`}}}}function _r(n,r,s){const c=n.find(k=>Z.MEASURE.includes(k.type));if(!c)throw new Error("No measure column found");const f=n.find(k=>Z.DIMENSION.includes(k.type));if(!f)throw new Error("No label column found");const h=r.reduce((k,R)=>{const B=R[f.name],V=R[c.name];return k[B]||(k[B]=0),k[B]=k[B]+V,k},{}),d=Object.keys(h).sort((k,R)=>h[R]-h[k]),a=d.slice(0,s),m=d.slice(s),I=a.map(k=>[k,h[k]]),g=m.reduce((k,R)=>k+h[R],0);return g&&I.push(["Others",g]),I}function Qr(n,r){const s=r.rows,c=n.label_column.dimension_name,f=n.value_column.measure_name,h=n.label_position||"left",d=s.map(I=>I[c]),a=s.map(I=>I[f]);let m=pr("blue");return{animation:!0,animationDuration:300,color:m,series:[{name:"Funnel",type:"funnel",orient:"vertical",funnelAlign:"center",top:"center",left:"center",width:"55%",height:"75%",minSize:"10px",maxSize:"100%",sort:"descending",label:{show:!0,position:h,color:"#565656",lineHeight:16,padding:[0,5,0,0],formatter:I=>{const g=d.indexOf(I.name),k=Number(a[g]/a[0]*100).toFixed(0),R=ge(a[g],2);return`${I.name}
${R} (${k}%)`}},labelLine:{show:!1},labelLayout(I){const g=I.rect.x-15,k=I.rect.x+I.rect.width+15;if(h==="left")return{x:g,align:"right"};if(h==="right")return{x:k,align:"left"};if(h==="alternate")return{x:I.dataIndex%2===0?g:k,align:I.dataIndex%2===0?"right":"left"}},gap:6,data:a.map((I,g)=>({name:d[g],value:I,itemStyle:{color:m[g],borderColor:m[g],borderWidth:4,borderCap:"round",borderJoin:"round"},emphasis:{itemStyle:{color:m[g],borderColor:m[g],borderWidth:6,borderCap:"round",borderJoin:"round"}}}))}]}}function wr(n,r,s){const c=n.find(m=>Z.MEASURE.includes(m.type));if(!c)throw new Error("No measure column found");const f=n.find(m=>Z.DIMENSION.includes(m.type));if(!f)throw new Error("No location column found");let h=f;const d=new Map;for(const m of r){const I=m[h.name],g=Gt(I),k=m[c.name],R=d.get(g)||0;d.set(g,R+k)}return Array.from(d.entries()).sort((m,I)=>I[1]-m[1]).map(([m,I])=>[m,I])}function vr(n,r){const s=Array.from({length:n.length+1},()=>Array(r+1).fill(0)),c=Array.from({length:n.length+1},()=>Array(r+1).fill(0));for(let f=1;f<=r;f++){s[1][f]=1,c[1][f]=0;for(let h=2;h<=n.length;h++)c[h][f]=1/0}return{mat1:s,mat2:c}}function xr(n,r,s,c){for(let f=2;f<=n.length;f++){let h=0,d=0,a=0;for(let m=1;m<=f;m++){const I=f-m+1,g=n[I-1];d+=g*g,h+=g,a++;const k=d-h*h/a,R=I-1;if(R!==0)for(let B=2;B<=r;B++)c[f][B]>=k+c[R][B-1]&&(s[f][B]=I,c[f][B]=k+c[R][B-1])}s[f][1]=1,c[f][1]=d-h*h/a}}function gr(n,r){n=n.slice().sort((a,m)=>a-m);const{mat1:s,mat2:c}=vr(n,r);xr(n,r,s,c);const f=Array(r+1).fill(0);f[r]=n[n.length-1];let h=n.length,d=r;for(;d>=2;){const a=s[h][d]-2;f[d-1]=n[a],h=s[h][d]-1,d--}return f[0]=n[0],f}function br(n){if(n.length===0)return[{min:0,max:0,label:"0"}];const r=n.filter(a=>typeof a=="number"&&!isNaN(a)&&a>0);if(r.length===0)return[{min:0,max:0,label:"0"}];if(r.length===1)return[{min:0,max:r[0],label:ge(r[0],1)}];const s=r.sort((a,m)=>a-m),c=[...new Set(s)],f=Math.min(5,c.length),h=gr(c,f),d=[];for(let a=0;a<h.length-1;a++){const m=h[a+1],I=a===0?0:h[a];d.push({gt:I,lte:m,label:ge(m,1)})}return d.reverse()}function Yr(n,r){const s=r.columns,c=r.rows,f=s.find(g=>Z.MEASURE.includes(g.type)),h=s.find(g=>Z.DIMENSION.includes(g.type));if(!f||!h)return null;let d="";n.map_type==="world"?d="world":n.map_type==="india"&&(d="india");const a=wr(s,c),m=a.map(g=>g[1]);return{height:"100%",animation:!0,animationDuration:300,tooltip:{trigger:"item",formatter:g=>{const k=g.value?ge(g.value,2):"0";return`<div class="flex items-center justify-between gap-5">
					<div>${g.name}</div>
					<div class="font-bold">${k}</div>
				</div>`}},visualMap:{type:"piecewise",pieces:br(m),itemSymbol:"circle",inRange:{color:["#dbeeff","#b7ddff","#92cdff","#6ebcff","#4aabff"]}},series:[{name:f.name,type:"map",map:d,projection:{project:g=>[g[0]/180*Math.PI,-Math.log(Math.tan((Math.PI/2+g[1]/180*Math.PI)/2))],unproject:g=>[g[0]*180/Math.PI,2*180/Math.PI*Math.atan(Math.exp(g[1]))-90]},data:a.map(g=>({name:g[0],value:g[1]})),itemStyle:{color:"rgb(68, 68, 68)",areaColor:"rgb(243, 243, 243)",borderWidth:.5,borderColor:"rgb(124, 124, 124)"},emphasis:!1,selectedMode:!1}]}}function Ft(n={}){let r=n.show_legend?36:22;return n.show_scrollbar&&!n.swapAxes&&(r+=30),{top:18,left:30,right:30,bottom:r,containLabel:!0}}function It(n={}){return{trigger:"axis",confine:!0,appendToBody:!1,formatter:r=>{if(Array.isArray(r)&&(r=r.filter(s=>{var c;return((c=s.value)==null?void 0:c[1])!==0}).sort((s,c)=>{var f,h;return((f=c.value)==null?void 0:f[1])-((h=s.value)==null?void 0:h[1])})),!Array.isArray(r)){const s=r,c=n.xySwapped?s.value[0]:s.value[1],f=isNaN(c)?c:Pe(c);return`
					<div class="flex items-center justify-between gap-5">
						<div>${s.name}</div>
						<div class="font-bold">${f}</div>
					</div>
				`}if(Array.isArray(r))return r.map((c,f)=>{const h=n.xySwapped?c.value[1]:c.value[0],d=n.xySwapped?c.value[0]:c.value[1],a=n.xAxisIsDate&&n.granularity?Pt(h,n.granularity):h,m=isNaN(d)?d:Pe(d);return`
							<div class="flex flex-col">
								${f==0?`<div>${a}</div>`:""}
								<div class="flex items-center justify-between gap-5">
									<div class="flex gap-1 items-center">
										${c.marker}
										<div>${c.seriesName}</div>
									</div>
									<div class="font-bold">${m}</div>
								</div>
							</div>
						`}).join("")}}}function tt(n=!0,r=!1,s=!1){let c="bottom";return r&&!s&&(c=32),{show:n,icon:"circle",type:"scroll",orient:"horizontal",bottom:c,itemGap:16,padding:[10,30],textStyle:{padding:[0,0,0,-4]},pageIconSize:10,pageIconColor:"#64748B",pageIconInactiveColor:"#C0CCDA",pageFormatter:"{current}",pageButtonItemGap:2}}function pt(n){return n&&n.column_name?{dimension:n}:n}function Er(n){return Array.isArray(n)?{series:n.map(r=>({measure:r}))}:n}function kr(n){var s,c;const r=f=>(f&&typeof f=="object"&&!f.dimension_name&&f.column_name&&(f.dimension_name=f.column_name),f);return(s=n.x_axis)!=null&&s.dimension&&(n.x_axis.dimension=r(n.x_axis.dimension)),(c=n.split_by)!=null&&c.dimension&&(n.split_by.dimension=r(n.split_by.dimension)),n.date_column&&(n.date_column=r(n.date_column)),n.label_column&&(n.label_column=r(n.label_column)),n.rows&&n.rows.length&&(n.rows=n.rows.map(r)),n.columns&&n.columns.length&&(n.columns=n.columns.map(r)),n}function Ct(n,r){var s,c,f,h;if("x_axis"in r&&r.x_axis.dimension.dimension_name===n)return r.x_axis.dimension.granularity;if("split_by"in r&&((c=(s=r.split_by)==null?void 0:s.dimension)==null?void 0:c.dimension_name)===n)return r.split_by.dimension.granularity;if("date_column"in r&&((f=r.date_column)==null?void 0:f.dimension_name)===n)return r.date_column.granularity;if("label_column"in r&&((h=r.label_column)==null?void 0:h.dimension_name)===n)return r.label_column.granularity;if("rows"in r){const d=r.rows.find(a=>a.dimension_name===n);if(d)return d.granularity}if("columns"in r){const d=r.columns.find(a=>a.dimension_name===n);if(d)return d.granularity}}const yt=new Map;function St(n){const r=String(n),s=yt.get(r);if(s)return s;const c=Ar(n);return yt.set(r,c),c}function Ar(n){const r=Dt(n);r.onAfterLoad(()=>ae(r.doc.data_query)),me(()=>r.doc.query,()=>r.isloaded&&c());const s=ue(()=>r.isloaded?ae(r.doc.data_query):{});async function c(v){if(await he(()=>r.isloaded&&s.value.isloaded&&ae(r.doc.query).isloaded),!f())return;const D=ae("new-query-"+ce());if(h(D),d(D),a(D),B(D),V(D),!!(v||!s.value.result.executedSQL||s.value.adhocFilters||JSON.stringify(D.doc.operations)!==JSON.stringify(s.value.doc.operations)))return s.value.setOperations(Je(D.doc.operations)),s.value.doc.use_live_connection=D.doc.use_live_connection,s.value.execute(v)}function f(){var F,D,y,A,_;const v=[];if(r.doc.query||v.push({variant:"error",message:"Query is required"}),r.doc.chart_type||v.push({variant:"error",message:"Chart type is required"}),fr.includes(r.doc.chart_type)||v.push({variant:"error",message:"Invalid chart type: "+r.doc.chart_type}),xe.includes(r.doc.chart_type)){const b=r.doc.config;(!b.x_axis.dimension||!b.x_axis.dimension.column_name)&&v.push({variant:"error",message:"X-axis is required"}),b.x_axis.dimension.column_name===((F=b.split_by)==null?void 0:F.dimension.column_name)&&v.push({variant:"error",message:"X-axis and Split by cannot be the same"})}if(r.doc.chart_type==="Number"&&((D=r.doc.config.number_columns)!=null&&D.filter(S=>S.measure_name).length||v.push({variant:"error",message:"Number column is required"})),r.doc.chart_type==="Donut"||r.doc.chart_type==="Funnel"){const b=r.doc.config;(y=b.label_column)!=null&&y.column_name||v.push({variant:"error",message:"Label column is required"}),(A=b.value_column)!=null&&A.measure_name||v.push({variant:"error",message:"Value column is required"})}if(r.doc.chart_type==="Table"&&((_=r.doc.config.rows)!=null&&_.filter(S=>S.column_name).length||v.push({variant:"error",message:"Rows are required"})),r.doc.chart_type==="Map"){const b=r.doc.config,S=b.location_column.column_name,Q=b.value_column.measure_name;S||v.push({variant:"error",message:"Location column is required"}),Q||v.push({variant:"error",message:"Value column is required"})}return!v.length}function h(v){v.setSource({table:Jt({query_name:r.doc.query})})}function d(v){var F,D;(D=(F=r.doc.config.filters)==null?void 0:F.filters)!=null&&D.length&&v.addFilterGroup(r.doc.config.filters)}function a(v){xe.includes(r.doc.chart_type)&&m(v),r.doc.chart_type==="Number"&&I(v),(r.doc.chart_type==="Donut"||r.doc.chart_type==="Funnel")&&g(v),r.doc.chart_type==="Table"&&k(v),r.doc.chart_type==="Map"&&R(v)}function m(v){var y,A,_;const F=r.doc.config;let D=(y=F.y_axis)==null?void 0:y.series.map(b=>b.measure).filter(b=>b.measure_name);if(D=D!=null&&D.length?D:[Ht()],(_=(A=F.split_by)==null?void 0:A.dimension)!=null&&_.column_name){v.addPivotWider({rows:[F.x_axis.dimension],columns:[F.split_by.dimension],values:D,max_column_values:F.split_by.max_split_values||10});return}v.addSummarize({measures:D,dimensions:[F.x_axis.dimension]})}function I(v){var D,y;const F=r.doc.config;v.addSummarize({measures:(D=F.number_columns)==null?void 0:D.filter(A=>A.measure_name),dimensions:(y=F.date_column)!=null&&y.column_name?[F.date_column]:[]})}function g(v){const F=r.doc.config;v.addSummarize({measures:[F.value_column],dimensions:[F.label_column]}),v.addOrderBy({column:fe(F.value_column.measure_name),direction:"desc"})}function k(v){const F=r.doc.config;let D=F.rows.filter(_=>_.column_name),y=F.columns.filter(_=>_.column_name),A=F.values.filter(_=>_.measure_name);if(A=A.length?A:[],y.length){v.addPivotWider({rows:D,columns:y,values:A,max_column_values:F.max_column_values||10});return}v.addSummarize({measures:A,dimensions:D})}function R(v){const F=r.doc.config;let D=[F.location_column];v.addSummarize({measures:[F.value_column],dimensions:D})}function B(v){r.doc.config.order_by.forEach(F=>{F.column.column_name&&F.direction&&v.addOrderBy({column:fe(F.column.column_name),direction:F.direction})})}function V(v){r.doc.config.limit&&v.addLimit(r.doc.config.limit)}function P(v,F){var D,y,A;"x_axis"in r.doc.config&&((y=(D=r.doc.config.x_axis)==null?void 0:D.dimension)==null?void 0:y.dimension_name)===v&&(r.doc.config.x_axis.dimension.granularity=F),"date_column"in r.doc.config&&((A=r.doc.config.date_column)==null?void 0:A.dimension_name)===v&&(r.doc.config.date_column.granularity=F),"rows"in r.doc.config&&r.doc.config.rows.forEach(_=>{_.dimension_name===v&&(_.granularity=F)})}function J(){return`${window.location.origin}/insights/shared/chart/${r.doc.name}`}function O(){return[r.doc.query,...Ke(r.doc.query)]}function W(){return O().map(v=>{const F=ae(v);return F.result.executedSQL||F.execute(),{group:F.doc.title,items:F.result.columnOptions.map(D=>{const y="`",A=`${y}${F.doc.name}${y}.${y}${D.value}${y}`;return{...D,value:A}})}})}function C(){r.doc.config={order_by:[],filters:r.doc.config.filters,limit:r.doc.config.limit}}qt(()=>r.doc.chart_type,(v,F)=>{v!==F&&(!v||!F||(xe.includes(v)&&!xe.includes(F)||!xe.includes(v)&&xe.includes(F))&&C())});function U(){r.call("export").then(v=>{He(JSON.stringify(v,null,2))})}const q=vt(ue({get:()=>r.doc,set:v=>Object.assign(r.doc,v)}),{deep:!0,capacity:100,debounce:500});return he(()=>r.isloaded).then(()=>{me(()=>r.doc.title,()=>{if(!r.doc.workbook)return;const v=Ze(r.doc.workbook);for(const F of v.doc.charts)if(F.name===r.doc.name){F.title=r.doc.title;break}},{debounce:500})}),Me({...Oe(r),dataQuery:s,refresh:c,updateGranularity:P,resetConfig:C,getShareLink:J,getDependentQueries:O,getDependentQueryColumns:W,copy:U,openInDesk:()=>window.open(`/app/insights-chart-v3/${r.doc.name}`,"_blank"),history:q})}const Fr={doctype:"Insights Chart v3",name:"",owner:"",title:"",workbook:"",query:"",data_query:"",chart_type:"",sort_order:0,is_public:!1,config:{},operations:[],read_only:!1};function Dt(n){const s=Te("Insights Chart v3",n,{initialDoc:{...Fr,name:n},enableAutoSave:!0,disableLocalStorage:!0,transform:Ir});return me(()=>s.doc.read_only,()=>{s.doc.read_only&&(s.autoSave=!1)}),s}function Ir(n){var r,s;return n.config=ve(n.config)||{},n.operations=ve(n.operations)||[],n.config.filters=(s=(r=n.config.filters)==null?void 0:r.filters)!=null&&s.length?n.config.filters:{filters:[],logical_operator:"And"},n.config.order_by=n.config.order_by||[],n.config.limit=n.config.limit||100,"x_axis"in n.config&&n.config.x_axis&&(n.config.x_axis=pt(n.config.x_axis)),"y_axis"in n.config&&Array.isArray(n.config.y_axis)&&(n.config.y_axis=Er(n.config.y_axis)),"split_by"in n.config&&n.config.split_by&&(n.config.split_by=pt(n.config.split_by)),n.chart_type==="Funnel"&&(n.config.label_position=n.config.label_position||"left"),n.chart_type==="Donut"&&(n.config.legend_position=n.config.legend_position||"bottom"),n.config=kr(n.config),n}function Cr(){return Dt("new-chart-"+ce())}function Vr(n){const r=[];return n==="String"&&(r.push({label:"is",value:"in"}),r.push({label:"is not",value:"not_in"}),r.push({label:"contains",value:"contains"}),r.push({label:"does not contain",value:"not_contains"}),r.push({label:"starts with",value:"starts_with"}),r.push({label:"ends with",value:"ends_with"}),r.push({label:"is set",value:"is_set"}),r.push({label:"is not set",value:"is_not_set"})),n==="Number"&&(r.push({label:"equals",value:"="}),r.push({label:"not equals",value:"!="}),r.push({label:"greater than",value:">"}),r.push({label:"greater than or equals",value:">="}),r.push({label:"less than",value:"<"}),r.push({label:"less than or equals",value:"<="}),r.push({label:"between",value:"between"}),r.push({label:"is set",value:"is_set"}),r.push({label:"is not set",value:"is_not_set"})),n==="Date"&&(r.push({label:"equals",value:"="}),r.push({label:"not equals",value:"!="}),r.push({label:"greater than",value:">"}),r.push({label:"greater than or equals",value:">="}),r.push({label:"less than",value:"<"}),r.push({label:"less than or equals",value:"<="}),r.push({label:"between",value:"between"}),r.push({label:"within",value:"within"}),r.push({label:"is set",value:"is_set"}),r.push({label:"is not set",value:"is_not_set"})),r}function Sr(n,r){if(!["is_set","is_not_set"].includes(n))return r==="String"?["in","not_in"].includes(n)?"select":"text":r==="Number"?n==="between"?"text":"number":r==="Date"?n==="between"?"date_range":n==="within"?"relative_date":"date":"text"}function Wr(n){return n.expression.expression.trim().length>0}function jr(n){return Z.TEXT.includes(n)?"String":Z.NUMBER.includes(n)?"Number":Z.DATE.includes(n)?"Date":"String"}function Dr(n,r){if(!n.column.column_name||!n.operator||!n.column.column_name||!n.operator)return!1;const s=Sr(n.operator,r);if(!s)return!0;if(!n.value&&n.value!==0)return!1;if(r==="Number")return n.operator==="between"?Array.isArray(n.value)&&n.value.length===2&&n.value.every(_t):_t(n.value);if(r==="String")return s==="select"?!!(Array.isArray(n.value)&&n.value.length&&n.value.every(c=>typeof c=="string")):typeof n.value=="string";if(r==="Date"){if(s==="date"||s==="relative_date")return typeof n.value=="string";if(s==="date_range")return!!(Array.isArray(n.value)&&n.value.length===2&&n.value.every(c=>typeof c=="string"))}return!1}function _t(n){const r=[null,void 0,""];return!isNaN(n)&&!r.includes(n)&&typeof n!="boolean"&&!isNaN(parseFloat(n))}const wt=new Map;function Br(n){const r=String(n),s=wt.get(r);if(s)return s;const c=Ur(n);return wt.set(r,c),c}function Ur(n){const r=Bt(n),s=ne(!1),c=ne();function f(_){return s.value&&c.value===r.doc.items.indexOf(_)}const h=ne({}),d=ne({});function a(_){const b=m();_.forEach(S=>{r.doc.items.some(Q=>Q.type==="chart"&&Q.chart===S.name)||r.doc.items.push({type:"chart",chart:S.name,layout:{i:ce(),x:0,y:b,w:S.chart_type==="Number"?20:10,h:S.chart_type==="Number"?3:8}})})}function m(){return Math.max(...r.doc.items.map(_=>_.layout.y+_.layout.h),0)}function I(){const _=m();r.doc.items.push({type:"text",text:"",layout:{i:ce(),x:0,y:_,w:10,h:1}}),c.value=r.doc.items.length-1}const g=20,k=4,R=1;function B(){r.doc.items.push({type:"filter",filter_name:"",filter_type:"String",links:{},layout:{i:ce(),x:0,y:0,w:k,h:R}}),P(),c.value=r.doc.items.length-1}function V(_){r.doc.items.splice(_,1),P()}function P(){const _=r.doc.items,b=_.filter(j=>j.type==="filter");if(b.length===0)return;let S=0,Q=0;b.forEach(j=>{const pe=j.layout.w||k;S+pe>g&&S>0&&(S=0,Q+=R),j.layout.x=S,j.layout.y=Q,j.layout.h=R,j.layout.w||(j.layout.w=k),S+=pe});const N=Q+R,X=_.filter(j=>j.type!=="filter");if(X.length===0)return;const te=Math.min(...X.map(j=>j.layout.y)),ee=N-te;ee!==0&&X.forEach(j=>{j.layout.y=Math.max(0,j.layout.y+ee)})}function J(_=!1){r.doc.items.filter(b=>b.type==="chart").forEach(b=>O(b.chart,_))}function O(_,b=!1){const S=St(_);S.dataQuery.adhocFilters=W(_),S.refresh(b)}function W(_){const b=r.doc.items.filter(N=>N.type==="filter"&&"links"in N&&N.links[_]);if(b.length===0)return;const S={};function Q(N,X){S[N]||(S[N]=je({logical_operator:"And",filters:[]})),S[N].filters.push(X)}return b.forEach(N=>{const X=N,te=q(X.links[_]);if(!te)return;const ee=d.value[X.filter_name]||{},j={column:fe(te.column),operator:ee.operator,value:ee.value};Dr(j,X.filter_type)&&Q(te.query,j)}),S}function C(_,b,S){r.doc.items.find(N=>N.type==="filter"&&N.filter_name===_)&&(b?d.value[_]={operator:b,value:S}:delete d.value[_],U(_))}function U(_){const b=r.doc.items.find(N=>N.type==="filter"&&N.filter_name===_);if(!b)return;const S=b;Object.keys(S.links).filter(N=>S.links[N]).forEach(N=>O(N))}function q(_){const b="`",S=new RegExp(`^${b}([^${b}]+)${b}\\.${b}([^${b}]+)${b}$`),Q=_.match(S);return!Q||Q.length<3?null:{query:Q[1],column:Q[2]}}function v(_,b,S){return r.call("get_distinct_column_values",{query:_,column_name:b,search_term:S})}function F(){return r.doc.share_link||`${window.location.origin}/insights/shared/dashboard/${r.doc.name}`}function D(_){return r.call("update_access",{data:_}).catch(we).then(()=>r.load())}const y=r.doc.items.reduce((_,b)=>{if(b.type!="filter")return _;const S=b;return S.default_operator&&S.default_value&&(_[S.filter_name]={operator:S.default_operator,value:S.default_value}),_},{});Object.assign(d.value,y);const A=`insights:dashboard-filter-states-${n}`;return d.value=Xt(A,()=>d.value),he(()=>r.isloaded).then(()=>{me(()=>r.doc.title,()=>{if(!r.doc.workbook)return;const _=Ze(r.doc.workbook);for(const b of _.doc.dashboards)if(b.name===r.doc.name){b.title=r.doc.title;break}},{debounce:500})}),Me({...Oe(r),editing:s,editingItemIndex:c,isEditingItem:f,filters:h,filterStates:d,addChart:a,addText:I,addFilter:B,removeItem:V,normalizeLayout:P,refresh:J,refreshChart:O,getAdhocFilters:W,updateFilterState:C,applyFilter:U,getColumnFromFilterLink:q,getDistinctColumnValues:v,updateAccess:D,getShareLink:F})}const Lr={doctype:"Insights Dashboard v3",name:"",owner:"",title:"",workbook:"",items:[],is_public:!1,is_shared_with_organization:!1,people_with_access:[],read_only:!1,vertical_compact:!0,has_workbook_access:!1};function Bt(n){const s=Te("Insights Dashboard v3",n,{initialDoc:{...Lr,name:n},enableAutoSave:!0,disableLocalStorage:!0,transform(c){return c.items=ve(c.items)||[],c}});return Ge.isLoggedIn&&s.onAfterLoad(()=>s.call("track_view").catch(()=>{})),me(()=>s.doc.read_only,()=>{s.doc.read_only&&(s.autoSave=!1)}),s}function Rr(){return Bt("new-dashboard-"+ce())}export{fr as C,We as E,Ze as a,St as b,ae as c,Vr as d,Sr as e,et as f,Ct as g,$r as h,_t as i,Nr as j,zr as k,Qr as l,Yr as m,Tr as n,jr as o,Wr as p,Dr as q,Br as u,Or as w};
//# sourceMappingURL=dashboard-37329027.js.map
