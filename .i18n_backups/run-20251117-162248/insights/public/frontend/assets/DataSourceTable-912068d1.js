import{_ as q}from"./Autocomplete-e91e4d1c.js";import{o as s,d as n,f as l,e as w,z as G,F as x,g as D,t as y,K as r,r as k,h as i,w as b,j as I,s as R,aG as H,u as v,P as S,D as O,E as J,T as M,am as Q,i as j,a0 as W,O as X,a5 as Y}from"./frappe-ui-d69b39da.js";import{k as Z}from"./index-9194c21d.js";import{P as ee}from"./PageBreadcrumbs-2c73064a.js";import{u as te}from"./useDataSourceTable-37863c71.js";import{_ as ae}from"./Popover-5414f173.js";import"./index-77f7bd6f.js";import"./toasts-2937f9d2.js";import"./calendar-1687c485.js";import"./clock-73e01da8.js";import"./house-94cdb6cd.js";import"./chevron-right-abc82e4c.js";import"./ellipsis-10a30b7b.js";import"./cacheStore-a53900e8.js";const oe={class:"relative flex flex-1 overflow-hidden rounded py-3"},le={key:0,class:"absolute top-0 flex h-full w-full items-center justify-center text-lg font-light text-gray-600"},se={class:"flex flex-1 flex-col overflow-auto text-base"},ne={key:0,class:"sticky top-0"},re={class:"whitespace-nowrap bg-gray-100 px-2.5 py-1.5 font-medium text-gray-600 first:rounded-l-md last:rounded-r-md",scope:"col"},ie={class:"border-b"},ce={class:"whitespace-nowrap bg-white px-2.5 py-2"},ue={__name:"Grid",props:["header","rows"],setup($){const c=$;return(g,u)=>(s(),n("div",oe,[c.rows.length==0?(s(),n("div",le,u[0]||(u[0]=[l("span",null,"No Data",-1)]))):w("",!0),l("div",se,[l("table",null,[c.header?(s(),n("thead",ne,[l("tr",null,[G(g.$slots,"header",{},()=>[(s(!0),n(x,null,D(c.header,m=>(s(),n("td",re,y(m),1))),256))])])])):w("",!0),l("tbody",null,[(s(!0),n(x,null,D(c.rows,(m,t)=>(s(),n("tr",ie,[(s(!0),n(x,null,D(m,e=>(s(),n("td",ce,y(r(Z)(e,100)),1))),256))]))),256))])])])]))}},de={class:"bg-gray-100 px-2.5 py-1.5 first:rounded-l-md last:rounded-r-md",scope:"col"},me={class:"flex items-center"},pe={class:"mr-2 overflow-hidden text-ellipsis whitespace-nowrap"},_e={class:"h-6"},be=["onClick"],ye={key:0,class:"flex items-end space-x-2 rounded bg-white px-3 py-2 shadow-md"},fe={__name:"DataSourceTableColumnHeader",props:{columns:Object},emits:["update-column-type"],setup($){return(c,g)=>{const u=k("FeatherIcon"),m=k("Input"),t=k("Button"),e=ae;return s(!0),n(x,null,D(c.$props.columns,d=>(s(),n("td",de,[l("div",me,[l("span",pe,y(d.label)+" : "+y(d.type),1),l("div",_e,[i(e,null,{target:b(({togglePopover:h})=>[l("div",{class:"cursor-pointer rounded p-1 hover:bg-gray-200",onClick:V=>h()},[i(u,{name:"more-horizontal",class:"h-4 w-4"})],8,be)]),body:b(({isOpen:h,togglePopover:V})=>[h?(s(),n("div",ye,[i(m,{class:"w-40",type:"select",label:"Change Type",options:["String","Integer","Decimal","Text","Datetime","Date","Time"],modelValue:d.type,"onUpdate:modelValue":f=>d.type=f},null,8,["modelValue","onUpdate:modelValue"]),i(t,{icon:"check",variant:"solid",onClick:f=>c.$emit("update-column-type",d)&V()},null,8,["onClick"])])):w("",!0)]),_:2},1024)])])]))),256)}}},ge={class:"sticky top-0 z-10 flex items-center bg-white px-5 py-2.5"},he={key:0,class:"ml-2 flex items-center space-x-2.5"},ve={class:"flex flex-1 flex-col overflow-hidden bg-white px-6 py-2"},xe={key:0,class:"flex flex-1 flex-col overflow-hidden"},ke={class:"flex flex-1 overflow-auto"},we={key:1,class:"mt-2 flex h-full w-full flex-col items-center justify-center rounded bg-gray-50"},$e={class:"space-y-4"},Ve={class:"mb-2 block text-sm leading-4 text-gray-700"},Ce={key:0},De={class:"mb-2 block text-sm leading-4 text-gray-700"},Ae={__name:"DataSourceTable",props:{name:{type:String,required:!0},table:{type:String,required:!0}},async setup($){let c,g;const u=$,m=I(!1),t=R({table:{},primaryKey:{},foreignKey:{}}),e=([c,g]=H(()=>te({name:u.table})),c=await c,g(),c);e.fetchPreview();const d=v({get(){return e.doc.hidden},set(a){a!==e.hidden&&e.updateVisibility(!!a)}}),h=S({url:"insights.api.data_sources.get_tables",params:{data_source:u.name},initialData:[],auto:!0}),V=v(()=>h.data.map(a=>({...a,value:a.table}))),f=S({url:"insights.api.data_sources.get_table_columns",initialData:[]});O(()=>t.table,a=>{a?f.submit({data_source:u.name,table:a.table}):T.value=[]});const T=v({get(){var a,o;return((o=(a=f.data)==null?void 0:a.columns)==null?void 0:o.map(_=>({label:`${_.label} (${_.type})`,value:_.column})))||[]},set(a){f.data=a}}),L=v(()=>!t.table||!(t.primaryKey&&t.primaryKey.value)||!(t.foreignKey&&t.foreignKey.value)),z=J("$notify"),B=S({url:"insights.api.data_sources.create_table_link",onSuccess(){t.table="",t.primaryKey="",t.foreignKey="",m.value=!1,z({variant:"success",title:"Success",message:"Link created successfully"})}}),E=v(()=>B.loading);function N(){L.value||B.submit({data_source:u.name,primary_table:{label:e.doc.label,table:e.doc.table},foreign_table:{label:t.table.label,table:t.table.table},primary_key:t.primaryKey.value,foreign_key:t.foreignKey.value})}const K=I(null);return O(m,async a=>{a&&(await Q(),setTimeout(()=>{K.value.input.$el.blur(),K.value.input.$el.focus()},500))}),M(()=>{var a;if((a=e.doc)!=null&&a.label){const o=e.doc.title||e.doc.label;document.title=`${o} - Frappe Insights`}}),(a,o)=>{var U,F;const _=q,P=k("Button"),A=k("Dialog");return s(),n(x,null,[l("header",ge,[i(ee,{class:"h-7",items:[{label:"Data Sources",href:"/data-source",route:{path:"/data-source"}},{label:u.name,route:{path:`/data-source/${u.name}`}},{label:((U=r(e).doc)==null?void 0:U.label)||u.table}]},null,8,["items"]),r(e).doc?(s(),n("div",he,[i(r(W),{variant:"subtle",theme:d.value?"gray":"green",size:"md"},{default:b(()=>[j(y(d.value?"Disabled":"Enabled"),1)]),_:1},8,["theme"]),i(r(X),{placement:"left",button:{icon:"more-horizontal",variant:"ghost"},options:[{label:d.value?"Enable":"Disable",icon:d.value?"eye":"eye-off",onClick:()=>d.value=!d.value},{label:"Sync Table",icon:"refresh-cw",onClick:()=>r(e).sync()},{label:"Add Link",icon:"link",onClick:()=>m.value=!0}]},null,8,["options"])])):w("",!0)]),l("div",ve,[r(e).doc&&r(e).doc.columns&&((F=r(e).rows)!=null&&F.data)&&!r(e).syncing?(s(),n("div",xe,[l("div",ke,[i(ue,{header:!0,rows:r(e).rows.data},{header:b(()=>[i(fe,{columns:r(e).doc.columns,onUpdateColumnType:r(e).updateColumnType},null,8,["columns","onUpdateColumnType"])]),_:1},8,["rows"])])])):(s(),n("div",we,[i(r(Y),{class:"mb-2 w-8 text-gray-500"}),o[4]||(o[4]=l("div",{class:"text-lg text-gray-600"},"Syncing columns from database...",-1))]))]),i(A,{options:{title:"Create a Link"},modelValue:m.value,"onUpdate:modelValue":o[3]||(o[3]=C=>m.value=C)},{"body-content":b(()=>{var C;return[l("div",$e,[l("div",null,[o[5]||(o[5]=l("div",{class:"mb-2 block text-sm leading-4 text-gray-700"},"Table",-1)),i(_,{ref_key:"$autocomplete",ref:K,modelValue:t.table,"onUpdate:modelValue":o[0]||(o[0]=p=>t.table=p),options:V.value,placeholder:"Select a table..."},null,8,["modelValue","options"])]),l("div",null,[l("div",Ve," Select a column from "+y(r(e).doc.label),1),i(_,{modelValue:t.primaryKey,"onUpdate:modelValue":o[1]||(o[1]=p=>t.primaryKey=p),options:r(e).doc.columns.map(p=>({label:`${p.label} (${p.type})`,value:p.column}))},null,8,["modelValue","options"])]),(C=t.table)!=null&&C.value?(s(),n("div",Ce,[l("div",De," Select a column from "+y(t.table.label),1),i(_,{modelValue:t.foreignKey,"onUpdate:modelValue":o[2]||(o[2]=p=>t.foreignKey=p),options:T.value},null,8,["modelValue","options"])])):w("",!0)])]}),actions:b(()=>[i(P,{variant:"solid",onClick:N,loading:E.value,disabled:L.value},{default:b(()=>o[6]||(o[6]=[j(" Create ")])),_:1},8,["loading","disabled"])]),_:1},8,["modelValue"])],64)}}};export{Ae as default};
//# sourceMappingURL=DataSourceTable-912068d1.js.map
