import{s as D,bg as q,bh as I,P as k,E as J,u as S,aI as V,D as z,r as K,o as f,d as L,f as p,y as N,K as l,h as B,e as $,c as h,w as _,J as T,an as W,t as H}from"./frappe-ui-d69b39da.js";import{B as Q,_ as U,a as A}from"./DashboardEmptyState-00d606e5.js";import{b as G,s as F}from"./index-9194c21d.js";import{w as g}from"./widgets-5dfe9af0.js";import M from"./InvalidWidget-252e2915.js";import{u as X}from"./useChartData-3320721f.js";import"./toasts-2937f9d2.js";import"./index-77f7bd6f.js";import"./calendar-1687c485.js";import"./clock-73e01da8.js";import"./chart-scatter-06f2042d.js";import"./list-filter-e596ffc3.js";import"./text-cursor-input-3636b908.js";import"./format-a2b0a407.js";import"./dayjs-e81f6541.js";function Y(a){const i=Z(a),t=D({isPublic:!0,doc:{doctype:"Insights Dashboard",name:void 0,owner:void 0,title:void 0,items:[]},loading:!1,itemLayouts:[],filterStates:{},filtersByChart:{},refreshCallbacks:[]});async function u(){t.loading=!0,await i.fetch(),t.doc=i.data,t.itemLayouts=t.doc.items.map(R),t.loading=!1}u();function c(e){return`filterState-${t.doc.name}-${e}`}async function r(e){return t.filterStates[e]||(t.filterStates[e]=await q(c(e))),t.filterStates[e]}async function d(e,s){const o=s?{operator:s.operator,value:s.value}:void 0;G(o,t.filterStates[e])||I(c(e),o).then(()=>{t.filterStates[e]=o,w(e)})}function w(e){t.doc.items.some(s=>{if(s.item_id===e)return(Object.keys(s.options.links)||[]).forEach(n=>{m(n)}),!0})}async function m(e){const s=t.doc.items.filter(n=>n.item_type==="Filter").map(async n=>{var C,x;const b=(C=n.options.links)==null?void 0:C[e];if(!b)return;const y=await r(n.item_id);if(!(!y||!((x=y.value)!=null&&x.value)))return{label:n.options.label,column:b,value:y.value.value,operator:y.operator.value,column_type:b.type}}),o=await Promise.all(s);t.filtersByChart[e]=o.filter(Boolean)}async function j(e){return t.filtersByChart[e]||await m(e),t.filtersByChart[e]}async function v(e,s){if(s||t.doc.items.some(n=>{if(n.item_id===e)return s=n.options.query,!0}),!s)throw new Error(`Query not found for item ${e}`);const o=await j(e);return await i.fetch_chart_data.submit({public_key:a,item_id:e,query_name:s,filters:o})}function E(e){const s=t.doc.items.find(o=>o.item_id===e);Object.keys(s.options.links).forEach(o=>{Object.keys(t.queryResults).forEach(n=>{n.startsWith(`${o}-`)&&(delete t.queryResults[n],v(o))})})}async function O(){await u(),t.refreshCallbacks.forEach(e=>e())}function P(e){t.refreshCallbacks.push(e)}function R(e){return{i:parseInt(e.item_id),x:e.layout.x||0,y:e.layout.y||0,w:e.layout.w||g[e.item_type].defaultWidth,h:e.layout.h||g[e.item_type].defaultHeight}}return Object.assign(t,{reload:u,getChartResults:v,getFilterStateKey:c,getFilterState:r,setFilterState:d,refreshFilter:E,refreshChartFilters:m,refresh:O,onRefresh:P,isChart:e=>!["Filter","Text"].includes(e.item_type)})}function Z(a){const i=k({url:"insights.api.public.get_public_dashboard",params:{public_key:a},transform(t){return t.items=t.items.map(tt),t}});return i.fetch_chart_data=k({url:"insights.api.public.get_public_dashboard_chart_data"}),i}function tt(a){return a.options=F(a.options,{}),a.layout=F(a.layout,{}),a}const et={class:"dashboard-item h-full min-h-[60px] w-full p-1.5"},at={class:"flex h-full w-full"},st={key:0,class:"absolute inset-0 z-[10000] flex h-full w-full items-center justify-center rounded bg-white"},rt={__name:"PublicDashboardItem",props:{item:{type:Object,required:!0}},setup(a){const i=J("dashboard"),t=a;let u=null,c=i.isChart(t.item),r=D({});if(c){const d=S(()=>t.item.options.query);r=X({resultsFetcher(){return i.getChartResults(t.item.item_id)}}),V(d,()=>r.load(d.value),{immediate:!0}),i.onRefresh(()=>r.load(d.value)),u=S(()=>i.filtersByChart[t.item.item_id]),i.refreshChartFilters(t.item.item_id),z(u,()=>{r.load(t.item.options.query)})}return(d,w)=>{const m=K("LoadingIndicator");return f(),L("div",et,[p("div",at,[p("div",{class:N(["group relative flex h-full w-full rounded",{"bg-white shadow":a.item.item_type!=="Filter"&&a.item.item_type!=="Text"}])},[l(r).loading?(f(),L("div",st,[B(m,{class:"w-6 text-gray-300"})])):$("",!0),(f(),h(T(l(g).getComponent(a.item.item_type)),{ref:"widget",data:l(r).data,item_id:a.item.item_id,options:a.item.options},{placeholder:_(()=>[B(M,{class:"absolute",title:"Insufficient options",icon:"settings",message:null,"icon-class":"text-gray-500"})]),_:1},8,["data","item_id","options"]))],2)])])}}},it={class:"whitespace-nowrap px-1.5 text-2xl font-medium"},ot={class:"h-full w-full overflow-y-auto bg-white px-4 py-2"},nt={ref:"gridLayout",class:"dashboard relative flex h-fit min-h-screen w-full flex-1 flex-col"},kt={__name:"PublicDashboard",props:{public_key:String},setup(a){const t=Y(a.public_key);return W("dashboard",t),(u,c)=>(f(),h(Q,null,{navbar:_(()=>[p("div",it,H(l(t).doc.title),1)]),content:_(()=>[p("div",ot,[p("div",nt,[(f(),h(U,{key:JSON.stringify(l(t).itemLayouts),class:"h-fit w-full",items:l(t).doc.items,disabled:!0,layouts:l(t).itemLayouts,"onUpdate:layouts":c[0]||(c[0]=r=>l(t).itemLayouts=r)},{item:_(({item:r})=>[(f(),h(rt,{item:r,key:r.item_id},null,8,["item"]))]),_:1},8,["items","layouts"])),l(t).doc.items.length?$("",!0):(f(),h(A,{key:0,class:"absolute left-1/2 top-1/2 mx-auto -translate-x-1/2 -translate-y-1/2 transform"}))],512)])]),_:1}))}};export{kt as default};
//# sourceMappingURL=PublicDashboard-3ba9ab39.js.map
